<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reproduce paper results â€¢ InfectionTrees</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Reproduce paper results">
<meta property="og:description" content="InfectionTrees">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">InfectionTrees</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/getting-started.html">Getting started with `InfectionTrees`</a>
    </li>
    <li class="divider">
    <li>
      <a href="../../articles/index.html">More...</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/skgallagher/InfectionTrees/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="reproduce-revised-paper-results_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Reproduce paper results</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/skgallagher/InfectionTrees/blob/master/vignettes/not-built-vignettes/reproduce-revised-paper-results.Rmd"><code>vignettes/not-built-vignettes/reproduce-revised-paper-results.Rmd</code></a></small>
      <div class="hidden name"><code>reproduce-revised-paper-results.Rmd</code></div>

    </div>

    
    
<div id="preliminaries" class="section level1">
<h1 class="hasAnchor">
<a href="#preliminaries" class="anchor"></a>Preliminaries</h1>
<ol style="list-style-type: decimal">
<li>Make sure <code>InfectionTrees</code> is installed (<code><a href="https://devtools.r-lib.org//reference/remote-reexports.html">devtools::install_github("skgallagher/InfectionTrees")</a></code>) and loaded along with the following libraries</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/skgallagher/InfectionTrees">InfectionTrees</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li><p>If there are any occurrences of <code><a href="https://devtools.r-lib.org//reference/load_all.html">devtools::load_all()</a></code>, remove them and replace with <code><a href="https://github.com/skgallagher/InfectionTrees">library(InfectionTrees)</a></code>.</p></li>
<li><p>Expected run time is an approximation for of estimated time to run the script. They were originally run on a laptop with the following specs unless otherwise specified.</p></li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Distributor ID<span class="sc">:</span> Ubuntu</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>Description<span class="sc">:</span>    Ubuntu <span class="dv">20</span>.<span class="fl">04.2</span> LTS</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>Release<span class="sc">:</span>    <span class="fl">20.04</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>Codename<span class="sc">:</span>   focal</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>Architecture<span class="sc">:</span>                    x86_64</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>CPU op<span class="sc">-</span><span class="fu">mode</span>(s)<span class="sc">:</span>                  <span class="dv">32</span><span class="sc">-</span>bit, <span class="dv">64</span><span class="sc">-</span>bit</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>Byte Order<span class="sc">:</span>                      Little Endian</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>Address sizes<span class="sc">:</span>                   <span class="dv">39</span> bits physical, <span class="dv">48</span> bits virtual</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">CPU</span>(s)<span class="sc">:</span>                          <span class="dv">8</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>On<span class="sc">-</span>line <span class="fu">CPU</span>(s) list<span class="sc">:</span>             <span class="dv">0-7</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">Thread</span>(s) per core<span class="sc">:</span>              <span class="dv">2</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">Core</span>(s) per socket<span class="sc">:</span>              <span class="dv">4</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">Socket</span>(s)<span class="sc">:</span>                       <span class="dv">1</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>NUMA <span class="fu">node</span>(s)<span class="sc">:</span>                    <span class="dv">1</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>Vendor ID<span class="sc">:</span>                       GenuineIntel</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>CPU family<span class="sc">:</span>                      <span class="dv">6</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>Model<span class="sc">:</span>                           <span class="dv">142</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>Model name<span class="sc">:</span>                      <span class="fu">Intel</span>(R) <span class="fu">Core</span>(TM) i7<span class="sc">-</span>10510U CPU <span class="sc">@</span> <span class="fl">1.80</span>GHz</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>Stepping<span class="sc">:</span>                        <span class="dv">12</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>CPU MHz<span class="sc">:</span>                         <span class="fl">1281.004</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>CPU max MHz<span class="sc">:</span>                     <span class="fl">4900.0000</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>CPU min MHz<span class="sc">:</span>                     <span class="fl">400.0000</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>BogoMIPS<span class="sc">:</span>                        <span class="fl">4599.93</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>Virtualization<span class="sc">:</span>                  VT<span class="sc">-</span>x</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>L1d cache<span class="sc">:</span>                       <span class="dv">128</span> KiB</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>L1i cache<span class="sc">:</span>                       <span class="dv">128</span> KiB</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>L2 cache<span class="sc">:</span>                        <span class="dv">1</span> MiB</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>L3 cache<span class="sc">:</span>                        <span class="dv">8</span> MiB</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>NUMA node0 <span class="fu">CPU</span>(s)<span class="sc">:</span>               <span class="dv">0-7</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>Vulnerability Itlb multihit<span class="sc">:</span>     KVM<span class="sc">:</span> Mitigation<span class="sc">:</span> VMX disabled</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>Vulnerability L1tf<span class="sc">:</span>              Not affected</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>Vulnerability Mds<span class="sc">:</span>               Not affected</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>Vulnerability Meltdown<span class="sc">:</span>          Not affected</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>Vulnerability Spec store bypass<span class="sc">:</span> Mitigation; Speculative Store Bypass disabled v</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>                                 ia prctl and seccomp</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>Vulnerability Spectre v1<span class="sc">:</span>        Mitigation; usercopy<span class="sc">/</span>swapgs barriers and __user</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>                                  pointer sanitization</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>Vulnerability Spectre v2<span class="sc">:</span>        Mitigation; Enhanced IBRS, IBPB conditional, RS</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>                                 B filling</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>Vulnerability Srbds<span class="sc">:</span>             Mitigation; TSX disabled</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>Vulnerability Tsx async abort<span class="sc">:</span>   Not affected</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>Flags<span class="sc">:</span>                           fpu vme de pse tsc msr pae mce cx8 apic sep mtr</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>                                 r pge mca cmov pat pse36 clflush dts acpi mmx f</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>                                 xsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rd</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>                                 tscp lm constant_tsc art arch_perfmon pebs bts </span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>                                 rep_good nopl xtopology nonstop_tsc cpuid aperf</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>                                 mperf pni pclmulqdq dtes64 monitor ds_cpl vmx e</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>                                 st tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid sse4_</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>                                 <span class="dv">1</span> sse4_2 x2apic movbe popcnt tsc_deadline_timer</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>                                  aes xsave avx f16c rdrand lahf_lm abm 3dnowpre</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>                                 fetch cpuid_fault epb invpcid_single ssbd ibrs </span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>                                 ibpb stibp ibrs_enhanced tpr_shadow vnmi flexpr</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>                                 iority ept vpid ept_ad fsgsbase tsc_adjust bmi1</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>                                  avx2 smep bmi2 erms invpcid mpx rdseed adx sma</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>                                 p clflushopt intel_pt xsaveopt xsavec xgetbv1 x</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>                                 saves dtherm ida arat pln pts hwp hwp_notify hw</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>                                 p_act_window hwp_epp md_clear flush_l1d arch_ca</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>                                 pabilities</span></code></pre></div>
</div>
<div id="file-structure" class="section level1">
<h1 class="hasAnchor">
<a href="#file-structure" class="anchor"></a>File Structure</h1>
<p>All code for reproducing our revised paper results may be found <a href="https://github.com/skgallagher/InfectionTrees/tree/master/revised_paper_results">here</a>.</p>
<p>Please clone the <a href="https://github.com/skgallagher/InfectionTrees/">entire repository</a> into your local directory and set your working directory to <code>revised_paper_results/</code></p>
<p>The results include the following:</p>
<ol style="list-style-type: decimal">
<li>Table 1 results. <code>table1-binary-cov-base-model-sims/</code>
<ol style="list-style-type: lower-alpha">
<li>Base model simulation results. <code>run-base-sims.R</code>
</li>
<li>Base model simulation bootstrap results. <code>run-base-sims-boot.R</code>
</li>
<li>Table output for base model simulation. <code>analyze-base-sims.R</code>
</li>
</ol>
</li>
<li>Table 2 results. <code>table2-binary-cov-mot-model-sims/</code>
<ol style="list-style-type: lower-alpha">
<li>Multiple outside transmissions model simulation results. <code>outsider-sims.R</code>
</li>
<li>Table output for base model simulation. <code>analyze-mot-sims.R</code>
</li>
</ol>
</li>
<li>The TB data results. <code>md-tb/</code>
<ol style="list-style-type: lower-alpha">
<li>Tables 3 and 4. <code>tab3-4-data-eda.R</code>
</li>
<li>Tables 5 and 6.
<ol style="list-style-type: lower-roman">
<li>Results from base and multiple outside transmissions model. <code>tb-data-base-and-mot.R</code>
</li>
<li>Bootstrap standard error for base and multiple outside transmissions model. <code>bootstrap-sims.R</code>
</li>
<li>Naive model results. <code>data-naive-model.R</code>
</li>
<li>Naive model bootstrap error. <code>data-naive-boot.R</code>
</li>
<li>Table outputs for the three models combined. <code>analyze-data-big-table.R</code>
</li>
</ol>
</li>
<li>Figure 4, most likely trees for the base model. <code>fig4-most-likely-trees.R</code>
</li>
</ol>
</li>
<li>Algorithm to compute whether we have enough samples <code>enough-MC-trees/sampling-enough-mc-trees.R</code>
</li>
</ol>
</div>
<div id="code-for-results-and-expected-run-time" class="section level1">
<h1 class="hasAnchor">
<a href="#code-for-results-and-expected-run-time" class="anchor"></a>Code for results and expected run time</h1>
<div id="table-1-results--table1-binary-cov-base-model-sims" class="section level2">
<h2 class="hasAnchor">
<a href="#table-1-results--table1-binary-cov-base-model-sims" class="anchor"></a>Table 1 results. <code>table1-binary-cov-base-model-sims/</code>
</h2>
<p>This table was produced by running the following three files in order.</p>
<div id="base-model-simulation-results--run-base-sims-r" class="section level3">
<h3 class="hasAnchor">
<a href="#base-model-simulation-results--run-base-sims-r" class="anchor"></a>Base model simulation results. <code>run-base-sims.R</code>
</h3>
<p>Expected run-time: ~3-5 hours</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#!/usr/bin/env Rscript</span>


<span class="co">## June 15, 2021</span>
<span class="co">## SKG</span>
<span class="co">## Rerun the simulations</span>
<span class="co">## This is for the base model with a binary covariate</span>
<span class="co">## We are using alpha values of .5, .7, .1</span>
<span class="co">## bet0 values of -2.5, -1.5, and -2.75</span>
<span class="co">## and beta1 values of -.5, 0, -.25</span>
<span class="co">## There are 15 total sets (so not all combinations are used)</span>

<span class="va">rep_from_lib</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>

<span class="kw">if</span><span class="op">(</span><span class="va">rep_from_lib</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/skgallagher/InfectionTrees">InfectionTrees</a></span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>



<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">6172021</span><span class="op">)</span>

<span class="co">## Simulations to try</span>
<span class="va">M</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># number of simulations for each parameter configuration</span>
<span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">5000</span> <span class="co"># number of MC samples</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="co"># number of clusters in a data set</span>


<span class="va">par_df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>,
                         <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span>,
                                <span class="fl">1</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>

<span class="va">par_df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>,
                         <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span>,
                                <span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span>

<span class="va">par_df3</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.75</span>, <span class="op">-</span><span class="fl">2.75</span>, <span class="op">-</span><span class="fl">2.75</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.25</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.25</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span>
<span class="co">###########################################################################</span>

<span class="co">## data frame of simulation parameter configurations</span>
<span class="va">par_df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">par_df1</span>, <span class="va">par_df2</span>, <span class="va">par_df3</span><span class="op">)</span>

<span class="va">out_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">par_df</span><span class="op">)</span><span class="op">)</span>

<span class="co">#########################################################################</span>

<span class="co">## Generate a small set of pre-sampled trees to get started</span>
<span class="va">binary_cluster_summaries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>cluster_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,
                                       x_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,
                                       x_neg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
                                       freq <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">mc_trees</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/sample_mc_binary_cov.html">sample_mc_binary_cov</a></span><span class="op">(</span>B <span class="op">=</span> <span class="va">B</span>,
                                 observed_cluster_summaries <span class="op">=</span>
                                     <span class="va">binary_cluster_summaries</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">freq</span><span class="op">)</span>



<span class="co">## Run the simulations</span>
<span class="va">total_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
<span class="kw">for</span><span class="op">(</span><span class="va">zz</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">par_df</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">t_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
  <span class="va">beta_0</span> <span class="op">&lt;-</span> <span class="va">par_df</span><span class="op">$</span><span class="va">beta_0</span><span class="op">[</span><span class="va">zz</span><span class="op">]</span>
  <span class="va">beta_1</span> <span class="op">&lt;-</span> <span class="va">par_df</span><span class="op">$</span><span class="va">beta_1</span><span class="op">[</span><span class="va">zz</span><span class="op">]</span>
  <span class="va">gamma</span> <span class="op">&lt;-</span> <span class="va">par_df</span><span class="op">$</span><span class="va">gamma</span><span class="op">[</span><span class="va">zz</span><span class="op">]</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Parameter set %d \n"</span>, <span class="va">zz</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"beta_0 = %.2f, beta_1 = %.2f, gamma = %.2f\n"</span>,
                <span class="va">beta_0</span>, <span class="va">beta_1</span>, <span class="va">gamma</span><span class="op">)</span><span class="op">)</span>


  <span class="co">## For a given set of parameters</span>
  <span class="va">best_params_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">M</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
  <span class="va">coverage_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">M</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">coverage_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lp_beta0"</span>, <span class="st">"lp_beta1"</span>,
                              <span class="st">"fi_beta0"</span>, <span class="st">"fi_beta1"</span><span class="op">)</span>
  <span class="va">cluster_sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">K</span> <span class="op">*</span> <span class="va">M</span><span class="op">)</span> <span class="co"># store all the cluster sizes from a simulated set of</span>
  <span class="co">## observed data</span>
  <span class="va">max_cluster_sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">mm</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span>
    <span class="va">t_sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Simulation %d \n"</span>, <span class="va">mm</span><span class="op">)</span><span class="op">)</span>
    <span class="co">## Simulate a branching process data set</span>
    <span class="co">## Distribution of xs</span>
    <span class="va">sample_covariates_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">gamma</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span>,
                                             <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">gamma</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

    <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/simulate_bp.html">simulate_bp</a></span><span class="op">(</span>K <span class="op">=</span> <span class="va">K</span> ,
                                      inf_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">beta_0</span>, <span class="va">beta_1</span><span class="op">)</span>,
                                      sample_covariates_df <span class="op">=</span> <span class="va">sample_covariates_df</span>,
                                      covariate_names <span class="op">=</span> <span class="st">"x"</span>,
                                      max_size <span class="op">=</span> <span class="fl">55</span><span class="op">)</span>
    <span class="co">## Summarize the data set</span>
    <span class="va">binary_cluster_summaries</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/summarize_binary_clusters.html">summarize_binary_clusters</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
    <span class="va">cluster_sizes</span><span class="op">[</span><span class="op">(</span><span class="va">mm</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span><span class="va">K</span> <span class="op">+</span>  <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">binary_cluster_summaries</span><span class="op">$</span><span class="va">cluster_size</span>,
                                         times <span class="op">=</span> <span class="va">binary_cluster_summaries</span><span class="op">$</span><span class="va">freq</span><span class="op">)</span>
    
    <span class="va">max_cluster_sizes</span><span class="op">[</span><span class="va">mm</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">binary_cluster_summaries</span><span class="op">$</span><span class="va">cluster_size</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"max cluster size is %d \n"</span>, <span class="va">max_cluster_sizes</span><span class="op">[</span><span class="va">mm</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

    <span class="co">## ##################################3</span>
    <span class="co">## SAMPLE (ADDITIONAL) MC TREES</span>
    <span class="co">## #######################################</span>
    <span class="va">size_npos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">binary_cluster_summaries</span>,
                      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">cluster_size</span>, <span class="st">"-"</span>, <span class="va">x_pos</span><span class="op">)</span><span class="op">)</span>
    <span class="va">sampled_size_npos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">mc_trees</span>,
                              <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">cluster_size</span>, <span class="st">"-"</span>, <span class="va">x_pos</span><span class="op">)</span><span class="op">)</span>
    <span class="va">missing_sample_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">size_npos</span> <span class="op">%in%</span> <span class="va">sampled_size_npos</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">missing_sample_ids</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span>
        <span class="va">new_cluster_summaries</span> <span class="op">&lt;-</span> <span class="va">binary_cluster_summaries</span><span class="op">[</span><span class="va">missing_sample_ids</span>,<span class="op">]</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Sampling the following trees"</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">size_npos</span><span class="op">[</span><span class="va">missing_sample_ids</span><span class="op">]</span><span class="op">)</span>
        <span class="va">new_mc_trees</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/sample_mc_binary_cov.html">sample_mc_binary_cov</a></span><span class="op">(</span>B <span class="op">=</span> <span class="va">B</span>,
                                             observed_cluster_summaries <span class="op">=</span>
                                                 <span class="va">new_cluster_summaries</span><span class="op">)</span> <span class="op">%&gt;%</span>
            <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">freq</span><span class="op">)</span>
        <span class="va">mc_trees</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">mc_trees</span>, <span class="va">new_mc_trees</span><span class="op">)</span> <span class="op">%&gt;%</span>
            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">cluster_size</span>, <span class="va">x_pos</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="co">#######################################</span>
    <span class="co">## OPTIMIZE</span>
    <span class="co">######################################</span>
    <span class="va">inf_params_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>

    <span class="va">best_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="va">inf_params_0</span>, fn <span class="op">=</span> <span class="va">bp_loglike_binary_cov</span>,
                         obs_data_summary <span class="op">=</span> <span class="va">binary_cluster_summaries</span>,
                        mc_samples_summary <span class="op">=</span> <span class="va">mc_trees</span>,
                                    return_neg <span class="op">=</span> <span class="cn">TRUE</span>,
                       lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="op">-</span><span class="fl">5</span><span class="op">)</span>,
                       upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>,
                       method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
                       hessian <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">best_params_mat</span><span class="op">[</span><span class="va">mm</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span>
    <span class="co">## Fisher information (approximately)</span>
    <span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">hessian</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">lower</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>
    <span class="va">upper</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>
    <span class="va">coverage_mat</span><span class="op">[</span><span class="va">mm</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">lower</span>  <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">beta_0</span>, <span class="va">beta_1</span><span class="op">)</span> <span class="op">&amp;</span>
                                 <span class="va">upper</span>  <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">beta_0</span>, <span class="va">beta_1</span><span class="op">)</span>,
                                 <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"best params"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">par</span><span class="op">)</span>

    <span class="co">## Likelihood profiles</span>
    <span class="co">## lp_ests &lt;- binary_likelihood_profs(best_pars = best_params$par,</span>
    <span class="co">##                                    max_loglike = -best_params$value,</span>
    <span class="co">##                                    obs_data_summary =</span>
    <span class="co">##                                        binary_cluster_summaries,</span>
    <span class="co">##                                    mc_samples_summary = mc_trees,</span>
    <span class="co">##                                    alpha = .05)</span>

<span class="co">#    print("95% CI from LP")</span>
  <span class="co">#  print(lp_ests)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"95% CI from FI"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">lower</span>, <span class="va">upper</span><span class="op">)</span><span class="op">)</span>

    <span class="co">## coverage_mat[mm, 1:2] &lt;- ifelse(lp_ests[,2] &lt; c(beta_0, beta_1) &amp;</span>
    <span class="co">##                              lp_ests[,3] &gt; c(beta_0, beta_1),</span>
    <span class="co">##                              1, 0)</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Data simulation time (hrs)"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t_sims</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3600</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Cumulative time (hrs)"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">total_time</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3600</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

  <span class="op">}</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Params simulation time (hrs)"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t_params</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3600</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>


  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"beta_0 = %.2f, beta_1 = %.2f, gamma = %.2f\n "</span>,
          <span class="va">beta_0</span>, <span class="va">beta_1</span>, <span class="va">gamma</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Mean estimates"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">best_params_mat</span><span class="op">)</span><span class="op">)</span>
   <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Median estimates"</span><span class="op">)</span>
 <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">best_params_mat</span>, <span class="fl">2</span>, <span class="va">median</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"2.5Q"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">best_params_mat</span>, <span class="fl">2</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">.025</span><span class="op">)</span><span class="op">)</span>
   <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"2.5Q"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">best_params_mat</span>, <span class="fl">2</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">.975</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Coverage beta0, beta1"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">coverage_mat</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Cluster sizes:"</span><span class="op">)</span>
  <span class="va">cluster_size_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">cluster_sizes</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">.9</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">cluster_size_summary</span><span class="op">)</span>

  <span class="va">sims_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>best_params_mat <span class="op">=</span> <span class="va">best_params_mat</span>,
                      set <span class="op">=</span> <span class="va">zz</span>,
                    max_cluster_sizes <span class="op">=</span> <span class="va">max_cluster_sizes</span>,
                    coverage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">coverage_mat</span><span class="op">)</span>,
                    cluster_size_summary <span class="op">=</span> <span class="va">cluster_size_summary</span><span class="op">)</span>

  <span class="va">out_list</span><span class="op">[[</span><span class="va">zz</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sims_list</span>

<span class="op">}</span>


<span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">" "</span>, <span class="st">"_"</span>, <span class="va">current_time</span><span class="op">)</span>
<span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">":"</span>, <span class="st">"."</span>, <span class="va">current_time</span><span class="op">)</span>
<span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"simulation_results_"</span>, <span class="va">current_time</span>, <span class="st">".RDS"</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="va">fn</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="base-model-bootstrap-simulation-results--run-base-sims-boot-r" class="section level2">
<h2 class="hasAnchor">
<a href="#base-model-bootstrap-simulation-results--run-base-sims-boot-r" class="anchor"></a>Base model bootstrap simulation results. <code>run-base-sims-boot.R</code>
</h2>
<p>Expected run-time: ~12-18 hours</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#!/usr/bin/env Rscript</span>


<span class="co">## June 18, 2021</span>
<span class="co">## SKG</span>
<span class="co">## Rerun the simulations</span>
<span class="co">## This is for the base model with a binary covariate</span>
<span class="co">## We are using alpha values of .5, .7, .1</span>
<span class="co">## beta0 values of -2.5, -1.5, and -2.75</span>
<span class="co">## and beta1 values of -.5, 0, -.25, 2.25</span>
<span class="co">## There are 15 total sets (so not all combinations are used)</span>
<span class="co">## This version includes a bootstrap resample woo</span>

<span class="va">rep_from_lib</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>


<span class="kw">if</span><span class="op">(</span><span class="va">rep_from_lib</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/skgallagher/InfectionTrees">InfectionTrees</a></span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">6172021</span><span class="op">)</span>

<span class="co">## Simulations to try</span>
<span class="va">M</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># number of simulations for each parameter configuration</span>
<span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">5000</span> <span class="co"># number of MC samples</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="co"># number of clusters in a data set</span>
<span class="va">n_boot</span> <span class="op">&lt;-</span> <span class="fl">30</span>


<span class="va">par_df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>,
                         <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span>,
                                <span class="fl">1</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>

<span class="va">par_df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>,
                         <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span>,
                                <span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span>

<span class="va">par_df3</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.75</span>, <span class="op">-</span><span class="fl">2.75</span>, <span class="op">-</span><span class="fl">2.75</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.25</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.25</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span>
<span class="co">###########################################################################</span>

<span class="co">## data frame of simulation parameter configurations</span>
<span class="va">par_df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">par_df1</span>, <span class="va">par_df2</span>, <span class="va">par_df3</span><span class="op">)</span>

<span class="va">out_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">par_df</span><span class="op">)</span><span class="op">)</span>

<span class="co">#########################################################################</span>

<span class="co">## Generate a small set of pre-sampled trees to get started</span>
<span class="va">binary_cluster_summaries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>cluster_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,
                                       x_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,
                                       x_neg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
                                       freq <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">mc_trees</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/sample_mc_binary_cov.html">sample_mc_binary_cov</a></span><span class="op">(</span>B <span class="op">=</span> <span class="va">B</span>,
                                 observed_cluster_summaries <span class="op">=</span>
                                     <span class="va">binary_cluster_summaries</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">freq</span><span class="op">)</span>



<span class="co">## Run the simulations</span>
<span class="va">total_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
<span class="kw">for</span><span class="op">(</span><span class="va">zz</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">par_df</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">t_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
  <span class="va">beta_0</span> <span class="op">&lt;-</span> <span class="va">par_df</span><span class="op">$</span><span class="va">beta_0</span><span class="op">[</span><span class="va">zz</span><span class="op">]</span>
  <span class="va">beta_1</span> <span class="op">&lt;-</span> <span class="va">par_df</span><span class="op">$</span><span class="va">beta_1</span><span class="op">[</span><span class="va">zz</span><span class="op">]</span>
  <span class="va">gamma</span> <span class="op">&lt;-</span> <span class="va">par_df</span><span class="op">$</span><span class="va">gamma</span><span class="op">[</span><span class="va">zz</span><span class="op">]</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Parameter set %d \n"</span>, <span class="va">zz</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"beta_0 = %.2f, beta_1 = %.2f, gamma = %.2f\n"</span>,
                <span class="va">beta_0</span>, <span class="va">beta_1</span>, <span class="va">gamma</span><span class="op">)</span><span class="op">)</span>


  <span class="co">## For a given set of parameters</span>
  <span class="va">best_params_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">M</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
  <span class="va">coverage_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">M</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">coverage_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"boot_beta0"</span>, <span class="st">"boot_beta1"</span>,
                              <span class="st">"fi_beta0"</span>, <span class="st">"fi_beta1"</span><span class="op">)</span>
  <span class="va">cluster_sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">K</span> <span class="op">*</span> <span class="va">M</span><span class="op">)</span> <span class="co"># store all the cluster sizes from a simulated set of</span>
  <span class="co">## observed data</span>
  <span class="va">max_cluster_sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">mm</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span>
    <span class="va">t_sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Simulation %d \n"</span>, <span class="va">mm</span><span class="op">)</span><span class="op">)</span>
    <span class="co">## Simulate a branching process data set</span>
    <span class="co">## Distribution of xs</span>
    <span class="va">sample_covariates_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">gamma</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span>,
                                             <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">gamma</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

    <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/simulate_bp.html">simulate_bp</a></span><span class="op">(</span>K <span class="op">=</span> <span class="va">K</span> ,
                                      inf_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">beta_0</span>, <span class="va">beta_1</span><span class="op">)</span>,
                                      sample_covariates_df <span class="op">=</span> <span class="va">sample_covariates_df</span>,
                                      covariate_names <span class="op">=</span> <span class="st">"x"</span>,
                                      max_size <span class="op">=</span> <span class="fl">60</span><span class="op">)</span>
    <span class="co">## Summarize the data set</span>
    <span class="va">binary_cluster_summaries</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/summarize_binary_clusters.html">summarize_binary_clusters</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
    <span class="va">cluster_sizes</span><span class="op">[</span><span class="op">(</span><span class="va">mm</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span><span class="va">K</span> <span class="op">+</span>  <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">binary_cluster_summaries</span><span class="op">$</span><span class="va">cluster_size</span>,
                                         times <span class="op">=</span> <span class="va">binary_cluster_summaries</span><span class="op">$</span><span class="va">freq</span><span class="op">)</span>
    
    <span class="va">max_cluster_sizes</span><span class="op">[</span><span class="va">mm</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">binary_cluster_summaries</span><span class="op">$</span><span class="va">cluster_size</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"max cluster size is %d \n"</span>, <span class="va">max_cluster_sizes</span><span class="op">[</span><span class="va">mm</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

    <span class="co">## ##################################3</span>
    <span class="co">## SAMPLE (ADDITIONAL) MC TREES</span>
    <span class="co">## #######################################</span>
    <span class="va">size_npos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">binary_cluster_summaries</span>,
                      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">cluster_size</span>, <span class="st">"-"</span>, <span class="va">x_pos</span><span class="op">)</span><span class="op">)</span>
    <span class="va">sampled_size_npos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">mc_trees</span>,
                              <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">cluster_size</span>, <span class="st">"-"</span>, <span class="va">x_pos</span><span class="op">)</span><span class="op">)</span>
    <span class="va">missing_sample_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">size_npos</span> <span class="op">%in%</span> <span class="va">sampled_size_npos</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">missing_sample_ids</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span>
        <span class="va">new_cluster_summaries</span> <span class="op">&lt;-</span> <span class="va">binary_cluster_summaries</span><span class="op">[</span><span class="va">missing_sample_ids</span>,<span class="op">]</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Sampling the following trees"</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">size_npos</span><span class="op">[</span><span class="va">missing_sample_ids</span><span class="op">]</span><span class="op">)</span>
        <span class="va">new_mc_trees</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/sample_mc_binary_cov.html">sample_mc_binary_cov</a></span><span class="op">(</span>B <span class="op">=</span> <span class="va">B</span>,
                                             observed_cluster_summaries <span class="op">=</span>
                                                 <span class="va">new_cluster_summaries</span><span class="op">)</span> <span class="op">%&gt;%</span>
            <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">freq</span><span class="op">)</span>
        <span class="va">mc_trees</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">mc_trees</span>, <span class="va">new_mc_trees</span><span class="op">)</span> <span class="op">%&gt;%</span>
            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">cluster_size</span>, <span class="va">x_pos</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="co">#######################################</span>
    <span class="co">## OPTIMIZE</span>
    <span class="co">######################################</span>
    <span class="va">inf_params_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>

    <span class="va">best_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="va">inf_params_0</span>, fn <span class="op">=</span> <span class="va">bp_loglike_binary_cov</span>,
                         obs_data_summary <span class="op">=</span> <span class="va">binary_cluster_summaries</span>,
                        mc_samples_summary <span class="op">=</span> <span class="va">mc_trees</span>,
                                    return_neg <span class="op">=</span> <span class="cn">TRUE</span>,
                       lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="op">-</span><span class="fl">5</span><span class="op">)</span>,
                       upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>,
                       method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
                       hessian <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">best_params_mat</span><span class="op">[</span><span class="va">mm</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span>
    <span class="co">## Fisher information (approximately)</span>
    <span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">hessian</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">lower</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>
    <span class="va">upper</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>
    <span class="va">coverage_mat</span><span class="op">[</span><span class="va">mm</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">lower</span>  <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">beta_0</span>, <span class="va">beta_1</span><span class="op">)</span> <span class="op">&amp;</span>
                                 <span class="va">upper</span>  <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">beta_0</span>, <span class="va">beta_1</span><span class="op">)</span>,
                                 <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>
    <span class="co">## #####################</span>
    <span class="co">## BOOSTRAP TO GET A SE</span>
    <span class="co">## #####################</span>
    
    <span class="va">boot_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">n_boot</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
    <span class="kw">for</span><span class="op">(</span><span class="va">bb</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_boot</span><span class="op">)</span><span class="op">{</span>
        <span class="co">## Resample data</span>
        <span class="va">resampled_cluster_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">binary_cluster_summaries</span><span class="op">)</span>,
                                         size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">binary_cluster_summaries</span><span class="op">$</span><span class="va">freq</span><span class="op">)</span>,
                                         prob <span class="op">=</span> <span class="va">binary_cluster_summaries</span><span class="op">$</span><span class="va">freq</span> <span class="op">/</span>
                                             <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">binary_cluster_summaries</span><span class="op">$</span><span class="va">freq</span><span class="op">)</span>,
                                         replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
        <span class="va">resampled_clusters</span> <span class="op">&lt;-</span> <span class="va">binary_cluster_summaries</span><span class="op">[</span><span class="va">resampled_cluster_inds</span>,<span class="op">]</span> <span class="op">%&gt;%</span>
            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster_size</span>, <span class="va">x_pos</span>, <span class="va">x_neg</span><span class="op">)</span> <span class="op">%&gt;%</span>
            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>freq <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span>

        <span class="co">## Get estimate of beta</span>
        <span class="va">best_params_boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="va">inf_params_0</span>, fn <span class="op">=</span> <span class="va">bp_loglike_binary_cov</span>,
                             obs_data_summary <span class="op">=</span> <span class="va">resampled_clusters</span>,
                             mc_samples_summary <span class="op">=</span> <span class="va">mc_trees</span>,
                             return_neg <span class="op">=</span> <span class="cn">TRUE</span>,
                             lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="op">-</span><span class="fl">5</span><span class="op">)</span>,
                             upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>,
                             method <span class="op">=</span> <span class="st">"L-BFGS-B"</span><span class="op">)</span>
        
        <span class="va">boot_mat</span><span class="op">[</span><span class="va">bb</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">best_params_boot</span><span class="op">$</span><span class="va">par</span>

    <span class="op">}</span>
    <span class="va">se_boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">boot_mat</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>
    <span class="va">lower_boot</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se_boot</span>
    <span class="va">upper_boot</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se_boot</span>
    <span class="va">coverage_mat</span><span class="op">[</span><span class="va">mm</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">lower_boot</span>  <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">beta_0</span>, <span class="va">beta_1</span><span class="op">)</span> <span class="op">&amp;</span>
                                 <span class="va">upper_boot</span>  <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">beta_0</span>, <span class="va">beta_1</span><span class="op">)</span>,
                                 <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>
    <span class="co">## #####################</span>

    
    

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"best params"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">par</span><span class="op">)</span>

    <span class="co">## Likelihood profiles</span>
    <span class="co">## lp_ests &lt;- binary_likelihood_profs(best_pars = best_params$par,</span>
    <span class="co">##                                    max_loglike = -best_params$value,</span>
    <span class="co">##                                    obs_data_summary =</span>
    <span class="co">##                                        binary_cluster_summaries,</span>
    <span class="co">##                                    mc_samples_summary = mc_trees,</span>
    <span class="co">##                                    alpha = .05)</span>

<span class="co">#    print("95% CI from LP")</span>
  <span class="co">#  print(lp_ests)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"95% CI from FI"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">lower</span>, <span class="va">upper</span><span class="op">)</span><span class="op">)</span>

    <span class="co">## coverage_mat[mm, 1:2] &lt;- ifelse(lp_ests[,2] &lt; c(beta_0, beta_1) &amp;</span>
    <span class="co">##                              lp_ests[,3] &gt; c(beta_0, beta_1),</span>
    <span class="co">##                              1, 0)</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Data simulation time (hrs)"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t_sims</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3600</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Cumulative time (hrs)"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">total_time</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3600</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

  <span class="op">}</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Params simulation time (hrs)"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t_params</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3600</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>


  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"beta_0 = %.2f, beta_1 = %.2f, gamma = %.2f\n "</span>,
          <span class="va">beta_0</span>, <span class="va">beta_1</span>, <span class="va">gamma</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Mean estimates"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">best_params_mat</span><span class="op">)</span><span class="op">)</span>
   <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Median estimates"</span><span class="op">)</span>
 <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">best_params_mat</span>, <span class="fl">2</span>, <span class="va">median</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"2.5Q"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">best_params_mat</span>, <span class="fl">2</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">.025</span><span class="op">)</span><span class="op">)</span>
   <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"2.5Q"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">best_params_mat</span>, <span class="fl">2</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">.975</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Coverage beta0, beta1"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">coverage_mat</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Cluster sizes:"</span><span class="op">)</span>
  <span class="va">cluster_size_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">cluster_sizes</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">.9</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">cluster_size_summary</span><span class="op">)</span>

  <span class="va">sims_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>best_params_mat <span class="op">=</span> <span class="va">best_params_mat</span>,
                      set <span class="op">=</span> <span class="va">zz</span>,
                    max_cluster_sizes <span class="op">=</span> <span class="va">max_cluster_sizes</span>,
                    coverage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">coverage_mat</span><span class="op">)</span>,
                    cluster_size_summary <span class="op">=</span> <span class="va">cluster_size_summary</span>,
                    n_boot <span class="op">=</span> <span class="va">n_boot</span><span class="op">)</span>

  <span class="va">out_list</span><span class="op">[[</span><span class="va">zz</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sims_list</span>

<span class="op">}</span>


<span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">" "</span>, <span class="st">"_"</span>, <span class="va">current_time</span><span class="op">)</span>
<span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">":"</span>, <span class="st">"."</span>, <span class="va">current_time</span><span class="op">)</span>
<span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"simulation_results_boot_"</span>, <span class="va">current_time</span>, <span class="st">".RDS"</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="va">fn</span><span class="op">)</span></code></pre></div>
</div>
<div id="table-output-for-base-model-simulation--analyze-base-sims-r" class="section level2">
<h2 class="hasAnchor">
<a href="#table-output-for-base-model-simulation--analyze-base-sims-r" class="anchor"></a>Table output for base model simulation. <code>analyze-base-sims.R</code>
</h2>
<p>Expected run-time: ~seconds, given the above completed results.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## SKG</span>
<span class="co">## July 31, 2020</span>
<span class="co">## Analyze simulations</span>
<span class="co">## JUNE 15, 2021 UPDATES FOR JCGS REVISION</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/">viridis</a></span><span class="op">)</span>


<span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">".RDS"</span>, <span class="va">fn</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">out_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">fn</span><span class="op">)</span><span class="op">)</span>


<span class="co">## Parameter sets</span>

<span class="co">## Simulations to try</span>
<span class="va">M</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># number of simulations for each parameter configuration</span>
<span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">5000</span> <span class="co"># number of MC samples</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="co"># number of clusters in a data set</span>


<span class="va">par_df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>,
                         <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span>,
                                <span class="fl">1</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>

<span class="va">par_df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>,
                         <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span>,
                                <span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span>

<span class="va">par_df3</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.75</span>, <span class="op">-</span><span class="fl">2.75</span>, <span class="op">-</span><span class="fl">2.75</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.25</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.25</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span>
<span class="co">###########################################################################</span>

<span class="co">## data frame of simulation parameter configurations</span>
<span class="va">par_df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">par_df1</span>, <span class="va">par_df2</span>, <span class="va">par_df3</span><span class="op">)</span>


<span class="va">sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">mean_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
                                   <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span>,
                                   <span class="va">colMeans</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">mean_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">mat</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>mean_beta0 <span class="op">=</span> <span class="va">V1</span>,
           mean_beta1 <span class="op">=</span> <span class="va">V2</span><span class="op">)</span>

<span class="va">med_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">mat</span>, <span class="fl">2</span>, <span class="va">median</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>med_beta0 <span class="op">=</span> <span class="va">V1</span>,
           med_beta1 <span class="op">=</span> <span class="va">V2</span><span class="op">)</span>

<span class="va">iqr_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">mat</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
            <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, prob <span class="op">=</span> <span class="fl">.75</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, prob <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span>
        <span class="op">}</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>IQR_beta0 <span class="op">=</span> <span class="va">V1</span>,
           IQR_beta1 <span class="op">=</span> <span class="va">V2</span><span class="op">)</span>

<span class="va">se_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">mat</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
            <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="op">}</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>se_beta0 <span class="op">=</span> <span class="va">V1</span>,
           se_beta1 <span class="op">=</span> <span class="va">V2</span><span class="op">)</span>

<span class="va">summary_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">par_df</span>,
                    <span class="va">mean_pars</span>,
                    <span class="va">med_pars</span>,
                    <span class="va">iqr_pars</span>,
                    <span class="va">se_pars</span>,
                    <span class="va">cov</span>,
                    <span class="va">sizes</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">`100%`</span>, <span class="va">`90%`</span><span class="op">)</span>

<span class="va">pretty_df</span> <span class="op">&lt;-</span> <span class="va">summary_df</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"("</span>, <span class="va">`100%`</span>,
                          <span class="st">", "</span>, <span class="va">`90%`</span>,
                          <span class="st">", "</span>, <span class="va">`50%`</span>,
                          <span class="st">")"</span><span class="op">)</span>,
           prob_pos <span class="op">=</span> <span class="va">gamma</span>,
           betas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"("</span>, <span class="va">beta_0</span>,
                          <span class="st">", "</span>, <span class="va">beta_1</span>,
                          <span class="st">")"</span><span class="op">)</span>,
           est_betas1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">mean_beta0</span>, <span class="fl">2</span><span class="op">)</span>,
                               <span class="st">" ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">se_beta0</span>, <span class="fl">2</span><span class="op">)</span>,
                               <span class="st">"), "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">mean_beta1</span>, <span class="fl">2</span><span class="op">)</span>,
                               <span class="st">" ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">se_beta1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"))"</span><span class="op">)</span>,
           est_betas2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">med_beta0</span>, <span class="fl">2</span><span class="op">)</span>,
                               <span class="st">" ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">IQR_beta0</span>, <span class="fl">2</span><span class="op">)</span>,
                               <span class="st">"), "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">med_beta1</span>, <span class="fl">2</span><span class="op">)</span>,
                               <span class="st">" ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">IQR_beta1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"))"</span><span class="op">)</span>,
           cov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"["</span>, <span class="va">boot_beta0</span> <span class="op">*</span> <span class="fl">100</span>, <span class="st">", "</span>,
                        <span class="va">boot_beta1</span> <span class="op">*</span> <span class="fl">100</span>, <span class="st">"]\\%"</span><span class="op">)</span>
           <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">sizes</span>, <span class="va">prob_pos</span>, <span class="va">betas</span>,
           <span class="va">est_betas1</span>,
           <span class="va">est_betas2</span>,
           <span class="va">cov</span><span class="op">)</span>


<span class="va">pretty_df</span> <span class="op">%&gt;%</span>
    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="st">"latex"</span>, digits <span class="op">=</span> <span class="fl">2</span>, booktabs <span class="op">=</span> <span class="cn">TRUE</span>, align <span class="op">=</span> <span class="st">"c"</span>,
                 linesep <span class="op">=</span> <span class="st">""</span>,
                 col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"$|\\mathcal{C}|$ (Max, 90Q, 50Q)"</span>,
                               <span class="st">"P(+)"</span>,
                               <span class="st">"$(\\beta_0$, $\\beta_1)$"</span>,
                               <span class="st">"(Mean $\\hat{\\beta}_0$, (SE), Mean $\\hat{\\beta}_1$ (SE))"</span>,
                               <span class="st">"(Median $\\hat{\\beta}_0$, (IQR), Median $\\hat{\\beta}_1$ (IQR))"</span>,
                               <span class="st">"Coverage [$\\beta_0$, $\\beta_1$]"</span>
                               <span class="op">)</span>, escape <span class="op">=</span> <span class="cn">FALSE</span>,
                 caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Results of simulations where we generate from Model in Eq. \\eqref{eq:sim-mod}."</span>,
                 <span class="st">" For each row in the table, we generate 100 sets of outbreak data each with 1000 transmission trees for a given $P(+)$, $\\beta_0$ and $\\beta_1$. "</span>,
                 <span class="st">"to estimate the MLE of $\\bm{\\beta}$."</span>,
                 <span class="st">"The mean and bootstrap standard error (SE) along with the median and inner quartile range (IQR) "</span>,
                 <span class="st">"are reported over the 100 sets of outbreak data. "</span>,
                 <span class="st">"Additionally we report the coverage where a 95\\% CI was derived "</span>,
                 <span class="st">"using a bootstrap estimate of the SE."</span>
                 <span class="op">)</span>,
                 label <span class="op">=</span> <span class="st">"sim-results"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">kableExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>latex_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"scale_down"</span>,
                                                <span class="st">"striped"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="table-2-results--table2-binary-cov-mot-model-sims" class="section level1">
<h1 class="hasAnchor">
<a href="#table-2-results--table2-binary-cov-mot-model-sims" class="anchor"></a>Table 2 results. <code>table2-binary-cov-mot-model-sims/</code>
</h1>
<p>This table was produced by running the following two files in order.</p>
<div id="multiple-outside-transmissions-model-simulation-results--outsider-sims-r" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-outside-transmissions-model-simulation-results--outsider-sims-r" class="anchor"></a>Multiple outside transmissions model simulation results. <code>outsider-sims.R</code>
</h2>
<p>Expected run-time: ~30 hours</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#!/usr/bin/env Rscript</span>


<span class="co">## June 15, 2021</span>
<span class="co">## SKG</span>
<span class="co">## Rerun the simulations</span>
<span class="co">## This is for the base model with a binary covariate</span>
<span class="co">## We are using alpha values of .5, .7, .1</span>
<span class="co">## bet0 values of -2.5, -1.5, and -2.75</span>
<span class="co">## and beta1 values of -.5, 0, -.25</span>
<span class="co">## There are 15 total sets (so not all combinations are used)</span>

<span class="va">rep_from_lib</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>

<span class="kw">if</span><span class="op">(</span><span class="va">rep_from_lib</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/skgallagher/InfectionTrees">InfectionTrees</a></span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>



<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">6172021</span><span class="op">)</span>

<span class="co">## Simulations to try</span>
<span class="va">M</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># number of simulations for each parameter configuration</span>
<span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">5000</span> <span class="co"># number of MC samples</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="co"># number of clusters in a data set</span>


<span class="va">par_df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>,
                         <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span>,
                                <span class="fl">1</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>

<span class="va">par_df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>,
                         <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span>,
                                <span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span>

<span class="va">par_df3</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.75</span>, <span class="op">-</span><span class="fl">2.75</span>, <span class="op">-</span><span class="fl">2.75</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.25</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.25</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span>
<span class="co">###########################################################################</span>

<span class="co">## data frame of simulation parameter configurations</span>
<span class="va">par_df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">par_df1</span>, <span class="va">par_df2</span>, <span class="va">par_df3</span><span class="op">)</span>

<span class="va">out_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">par_df</span><span class="op">)</span><span class="op">)</span>

<span class="co">#########################################################################</span>

<span class="co">## Generate a small set of pre-sampled trees to get started</span>
<span class="va">binary_cluster_summaries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>cluster_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,
                                       x_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,
                                       x_neg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
                                       freq <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">mc_trees</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/sample_mc_binary_cov.html">sample_mc_binary_cov</a></span><span class="op">(</span>B <span class="op">=</span> <span class="va">B</span>,
                                 observed_cluster_summaries <span class="op">=</span>
                                     <span class="va">binary_cluster_summaries</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">freq</span><span class="op">)</span>



<span class="co">## Run the simulations</span>
<span class="va">total_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
<span class="kw">for</span><span class="op">(</span><span class="va">zz</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">par_df</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">t_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
  <span class="va">beta_0</span> <span class="op">&lt;-</span> <span class="va">par_df</span><span class="op">$</span><span class="va">beta_0</span><span class="op">[</span><span class="va">zz</span><span class="op">]</span>
  <span class="va">beta_1</span> <span class="op">&lt;-</span> <span class="va">par_df</span><span class="op">$</span><span class="va">beta_1</span><span class="op">[</span><span class="va">zz</span><span class="op">]</span>
  <span class="va">gamma</span> <span class="op">&lt;-</span> <span class="va">par_df</span><span class="op">$</span><span class="va">gamma</span><span class="op">[</span><span class="va">zz</span><span class="op">]</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Parameter set %d \n"</span>, <span class="va">zz</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"beta_0 = %.2f, beta_1 = %.2f, gamma = %.2f\n"</span>,
                <span class="va">beta_0</span>, <span class="va">beta_1</span>, <span class="va">gamma</span><span class="op">)</span><span class="op">)</span>


  <span class="co">## For a given set of parameters</span>
  <span class="va">best_params_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">M</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
  <span class="va">coverage_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">M</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">coverage_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lp_beta0"</span>, <span class="st">"lp_beta1"</span>,
                              <span class="st">"fi_beta0"</span>, <span class="st">"fi_beta1"</span><span class="op">)</span>
  <span class="va">cluster_sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">K</span> <span class="op">*</span> <span class="va">M</span><span class="op">)</span> <span class="co"># store all the cluster sizes from a simulated set of</span>
  <span class="co">## observed data</span>
  <span class="va">max_cluster_sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">mm</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span>
    <span class="va">t_sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Simulation %d \n"</span>, <span class="va">mm</span><span class="op">)</span><span class="op">)</span>
    <span class="co">## Simulate a branching process data set</span>
    <span class="co">## Distribution of xs</span>
    <span class="va">sample_covariates_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">gamma</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span>,
                                             <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">gamma</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

    <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/simulate_bp.html">simulate_bp</a></span><span class="op">(</span>K <span class="op">=</span> <span class="va">K</span> ,
                                      inf_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">beta_0</span>, <span class="va">beta_1</span><span class="op">)</span>,
                                      sample_covariates_df <span class="op">=</span> <span class="va">sample_covariates_df</span>,
                                      covariate_names <span class="op">=</span> <span class="st">"x"</span>,
                                      max_size <span class="op">=</span> <span class="fl">55</span><span class="op">)</span>
    <span class="co">## Summarize the data set</span>
    <span class="va">binary_cluster_summaries</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/summarize_binary_clusters.html">summarize_binary_clusters</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
    <span class="va">cluster_sizes</span><span class="op">[</span><span class="op">(</span><span class="va">mm</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span><span class="va">K</span> <span class="op">+</span>  <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">binary_cluster_summaries</span><span class="op">$</span><span class="va">cluster_size</span>,
                                         times <span class="op">=</span> <span class="va">binary_cluster_summaries</span><span class="op">$</span><span class="va">freq</span><span class="op">)</span>
    
    <span class="va">max_cluster_sizes</span><span class="op">[</span><span class="va">mm</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">binary_cluster_summaries</span><span class="op">$</span><span class="va">cluster_size</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"max cluster size is %d \n"</span>, <span class="va">max_cluster_sizes</span><span class="op">[</span><span class="va">mm</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

    <span class="co">## ##################################3</span>
    <span class="co">## SAMPLE (ADDITIONAL) MC TREES</span>
    <span class="co">## #######################################</span>
    <span class="va">size_npos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">binary_cluster_summaries</span>,
                      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">cluster_size</span>, <span class="st">"-"</span>, <span class="va">x_pos</span><span class="op">)</span><span class="op">)</span>
    <span class="va">sampled_size_npos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">mc_trees</span>,
                              <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">cluster_size</span>, <span class="st">"-"</span>, <span class="va">x_pos</span><span class="op">)</span><span class="op">)</span>
    <span class="va">missing_sample_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">size_npos</span> <span class="op">%in%</span> <span class="va">sampled_size_npos</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">missing_sample_ids</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span>
        <span class="va">new_cluster_summaries</span> <span class="op">&lt;-</span> <span class="va">binary_cluster_summaries</span><span class="op">[</span><span class="va">missing_sample_ids</span>,<span class="op">]</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Sampling the following trees"</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">size_npos</span><span class="op">[</span><span class="va">missing_sample_ids</span><span class="op">]</span><span class="op">)</span>
        <span class="va">new_mc_trees</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/sample_mc_binary_cov.html">sample_mc_binary_cov</a></span><span class="op">(</span>B <span class="op">=</span> <span class="va">B</span>,
                                             observed_cluster_summaries <span class="op">=</span>
                                                 <span class="va">new_cluster_summaries</span><span class="op">)</span> <span class="op">%&gt;%</span>
            <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">freq</span><span class="op">)</span>
        <span class="va">mc_trees</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">mc_trees</span>, <span class="va">new_mc_trees</span><span class="op">)</span> <span class="op">%&gt;%</span>
            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">cluster_size</span>, <span class="va">x_pos</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="co">#######################################</span>
    <span class="co">## OPTIMIZE</span>
    <span class="co">######################################</span>
    <span class="va">inf_params_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>

    <span class="va">best_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="va">inf_params_0</span>, fn <span class="op">=</span> <span class="va">bp_loglike_binary_cov</span>,
                         obs_data_summary <span class="op">=</span> <span class="va">binary_cluster_summaries</span>,
                        mc_samples_summary <span class="op">=</span> <span class="va">mc_trees</span>,
                                    return_neg <span class="op">=</span> <span class="cn">TRUE</span>,
                       lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="op">-</span><span class="fl">5</span><span class="op">)</span>,
                       upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>,
                       method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
                       hessian <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">best_params_mat</span><span class="op">[</span><span class="va">mm</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span>
    <span class="co">## Fisher information (approximately)</span>
    <span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">hessian</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">lower</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>
    <span class="va">upper</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>
    <span class="va">coverage_mat</span><span class="op">[</span><span class="va">mm</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">lower</span>  <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">beta_0</span>, <span class="va">beta_1</span><span class="op">)</span> <span class="op">&amp;</span>
                                 <span class="va">upper</span>  <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">beta_0</span>, <span class="va">beta_1</span><span class="op">)</span>,
                                 <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"best params"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">par</span><span class="op">)</span>

    <span class="co">## Likelihood profiles</span>
    <span class="co">## lp_ests &lt;- binary_likelihood_profs(best_pars = best_params$par,</span>
    <span class="co">##                                    max_loglike = -best_params$value,</span>
    <span class="co">##                                    obs_data_summary =</span>
    <span class="co">##                                        binary_cluster_summaries,</span>
    <span class="co">##                                    mc_samples_summary = mc_trees,</span>
    <span class="co">##                                    alpha = .05)</span>

<span class="co">#    print("95% CI from LP")</span>
  <span class="co">#  print(lp_ests)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"95% CI from FI"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">lower</span>, <span class="va">upper</span><span class="op">)</span><span class="op">)</span>

    <span class="co">## coverage_mat[mm, 1:2] &lt;- ifelse(lp_ests[,2] &lt; c(beta_0, beta_1) &amp;</span>
    <span class="co">##                              lp_ests[,3] &gt; c(beta_0, beta_1),</span>
    <span class="co">##                              1, 0)</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Data simulation time (hrs)"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t_sims</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3600</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Cumulative time (hrs)"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">total_time</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3600</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

  <span class="op">}</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Params simulation time (hrs)"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t_params</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3600</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>


  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"beta_0 = %.2f, beta_1 = %.2f, gamma = %.2f\n "</span>,
          <span class="va">beta_0</span>, <span class="va">beta_1</span>, <span class="va">gamma</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Mean estimates"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">best_params_mat</span><span class="op">)</span><span class="op">)</span>
   <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Median estimates"</span><span class="op">)</span>
 <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">best_params_mat</span>, <span class="fl">2</span>, <span class="va">median</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"2.5Q"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">best_params_mat</span>, <span class="fl">2</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">.025</span><span class="op">)</span><span class="op">)</span>
   <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"2.5Q"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">best_params_mat</span>, <span class="fl">2</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">.975</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Coverage beta0, beta1"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">coverage_mat</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Cluster sizes:"</span><span class="op">)</span>
  <span class="va">cluster_size_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">cluster_sizes</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">.9</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">cluster_size_summary</span><span class="op">)</span>

  <span class="va">sims_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>best_params_mat <span class="op">=</span> <span class="va">best_params_mat</span>,
                      set <span class="op">=</span> <span class="va">zz</span>,
                    max_cluster_sizes <span class="op">=</span> <span class="va">max_cluster_sizes</span>,
                    coverage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">coverage_mat</span><span class="op">)</span>,
                    cluster_size_summary <span class="op">=</span> <span class="va">cluster_size_summary</span><span class="op">)</span>

  <span class="va">out_list</span><span class="op">[[</span><span class="va">zz</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sims_list</span>

<span class="op">}</span>


<span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">" "</span>, <span class="st">"_"</span>, <span class="va">current_time</span><span class="op">)</span>
<span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">":"</span>, <span class="st">"."</span>, <span class="va">current_time</span><span class="op">)</span>
<span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"simulation_results_"</span>, <span class="va">current_time</span>, <span class="st">".RDS"</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="va">fn</span><span class="op">)</span></code></pre></div>
</div>
<div id="table-output-for-multiple-outside-transmissions-model-simulation--analyze-mot-sims-r" class="section level2">
<h2 class="hasAnchor">
<a href="#table-output-for-multiple-outside-transmissions-model-simulation--analyze-mot-sims-r" class="anchor"></a>Table output for multiple outside transmissions model simulation. <code>analyze-mot-sims.R</code>
</h2>
<p>Expected run-time: ~seconds, given the above completed results.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## SKG</span>
<span class="co">## July 31, 2020</span>
<span class="co">## Analyze simulations</span>
<span class="co">## JUNE 15, 2021 UPDATES FOR JCGS REVISION</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/">viridis</a></span><span class="op">)</span>


<span class="co">## Biowulf output from outsider-sims.R</span>
<span class="va">folder_name</span> <span class="op">&lt;-</span> <span class="st">"biowulf-results"</span>

<span class="va">filenames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">folder_name</span><span class="op">)</span><span class="op">)</span>

<span class="va">out_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">folder_name</span>, <span class="va">filenames</span><span class="op">)</span>,
                      <span class="va">readRDS</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>

<span class="co">## Parameter sets</span>

<span class="co">## Simulations to try</span>
<span class="va">M</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># number of simulations for each parameter configuration</span>
<span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">10000</span> <span class="co"># number of MC samples</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="co"># number of clusters in a data set</span>


<span class="va">par_df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>,
                         <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span>,
                                <span class="fl">1</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>

<span class="va">par_df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>, <span class="op">-</span><span class="fl">2.5</span>,
                         <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span>,
                                <span class="fl">.5</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.5</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span>

<span class="va">par_df3</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                     M <span class="op">=</span> <span class="va">M</span>,
                     B <span class="op">=</span> <span class="va">B</span>,
                     beta_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.75</span>, <span class="op">-</span><span class="fl">2.75</span>, <span class="op">-</span><span class="fl">2.75</span><span class="op">)</span>,
                     beta_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.25</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">.25</span><span class="op">)</span>,
                     gamma <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span>
<span class="co">###########################################################################</span>

<span class="co">## data frame of simulation parameter configurations</span>
<span class="va">par_df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">par_df1</span>, <span class="va">par_df2</span>, <span class="va">par_df3</span><span class="op">)</span>


<span class="va">sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">cov</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fi_beta0"</span>, <span class="st">"fi_beta1"</span><span class="op">)</span>

<span class="va">mean_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
                                   <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span>,
                                   <span class="va">colMeans</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">mean_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">mat</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>mean_beta0 <span class="op">=</span> <span class="va">V1</span>,
           mean_beta1 <span class="op">=</span> <span class="va">V2</span><span class="op">)</span>

<span class="va">med_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">mat</span>, <span class="fl">2</span>, <span class="va">median</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>med_beta0 <span class="op">=</span> <span class="va">V1</span>,
           med_beta1 <span class="op">=</span> <span class="va">V2</span><span class="op">)</span>

<span class="va">iqr_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">mat</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
            <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, prob <span class="op">=</span> <span class="fl">.75</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, prob <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span>
        <span class="op">}</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>IQR_beta0 <span class="op">=</span> <span class="va">V1</span>,
           IQR_beta1 <span class="op">=</span> <span class="va">V2</span><span class="op">)</span>

<span class="va">se_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">out_list</span>, <span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">mat</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
            <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
        <span class="op">}</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>se_beta0 <span class="op">=</span> <span class="va">V1</span>,
           se_beta1 <span class="op">=</span> <span class="va">V2</span><span class="op">)</span>

<span class="va">summary_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">par_df</span>,
                    <span class="va">mean_pars</span>,
                    <span class="va">med_pars</span>,
                    <span class="va">iqr_pars</span>,
                    <span class="va">se_pars</span>,
                    <span class="va">cov</span>,
                    <span class="va">sizes</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">max</span>, <span class="va">q90</span><span class="op">)</span>

<span class="va">pretty_df</span> <span class="op">&lt;-</span> <span class="va">summary_df</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"("</span>, <span class="va">`max`</span>,
                          <span class="st">", "</span>, <span class="va">`q90`</span>,
                          <span class="st">", "</span>, <span class="va">`med`</span>,
                          <span class="st">")"</span><span class="op">)</span>,
           prob_pos <span class="op">=</span> <span class="va">gamma</span>,
           betas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"("</span>, <span class="va">beta_0</span>,
                          <span class="st">", "</span>, <span class="va">beta_1</span>,
                          <span class="st">")"</span><span class="op">)</span>,
           est_betas1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">mean_beta0</span>, <span class="fl">2</span><span class="op">)</span>,
                               <span class="st">" ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">se_beta0</span>, <span class="fl">2</span><span class="op">)</span>,
                               <span class="st">"), "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">mean_beta1</span>, <span class="fl">2</span><span class="op">)</span>,
                               <span class="st">" ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">se_beta1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"))"</span><span class="op">)</span>,
           est_betas2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">med_beta0</span>, <span class="fl">2</span><span class="op">)</span>,
                               <span class="st">" ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">IQR_beta0</span>, <span class="fl">2</span><span class="op">)</span>,
                               <span class="st">"), "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">med_beta1</span>, <span class="fl">2</span><span class="op">)</span>,
                               <span class="st">" ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">IQR_beta1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"))"</span><span class="op">)</span>,
           cov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"["</span>, <span class="va">fi_beta0</span> <span class="op">*</span> <span class="fl">100</span>, <span class="st">", "</span>,
                        <span class="va">fi_beta1</span> <span class="op">*</span> <span class="fl">100</span>, <span class="st">"]\\%"</span><span class="op">)</span>
           <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">sizes</span>, <span class="va">prob_pos</span>, <span class="va">betas</span>,
           <span class="va">est_betas1</span>,
           <span class="va">est_betas2</span>,
           <span class="va">cov</span><span class="op">)</span>


<span class="va">pretty_df</span> <span class="op">%&gt;%</span>
    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="st">"latex"</span>, digits <span class="op">=</span> <span class="fl">2</span>, booktabs <span class="op">=</span> <span class="cn">TRUE</span>, align <span class="op">=</span> <span class="st">"c"</span>,
                 linesep <span class="op">=</span> <span class="st">""</span>,
                 col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"$|\\mathcal{C}|$ (Max, 90Q, 50Q)"</span>,
                               <span class="st">"P(+)"</span>,
                               <span class="st">"$(\\beta_0$, $\\beta_1)$"</span>,
                               <span class="st">"(Mean $\\hat{\\beta}_0$, (SE), Mean $\\hat{\\beta}_1$ (SE))"</span>,
                               <span class="st">"(Median $\\hat{\\beta}_0$, (IQR), Median $\\hat{\\beta}_1$ (IQR))"</span>,
                               <span class="st">"Coverage [$\\beta_0$, $\\beta_1$]"</span>
                               <span class="op">)</span>, escape <span class="op">=</span> <span class="cn">FALSE</span>,
                 caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Results of simulations where we first generate data from Model in Eq. \\eqref{eq:sim-mod}"</span>,
                                  <span class="st">"and then exclude the seed individual to reflect the outsider generation process"</span>,
                 <span class="st">" For each row in the table, we generate 100 sets of outbreak data each with 1000 transmission trees for a given $P(+)$, $\\beta_0$ and $\\beta_1$. "</span>,
                 <span class="st">"to estimate the MLE of $\\bm{\\beta}$.  However, fewer than 1000 transmission trees are observed once we exclude the first generation (the outside infection)."</span>,
                 <span class="st">"The mean and bootstrap standard error (SE) along with the median and inner quartile range (IQR) "</span>,
                 <span class="st">"are reported over the 100 sets of outbreak data. "</span>,
                 <span class="st">"Additionally we report the coverage where a 95\\% CI was derived "</span>,
                 <span class="st">"using a Fisher information derived estimate of the SE."</span>
                 <span class="op">)</span>,
                 label <span class="op">=</span> <span class="st">"sim-results-mot"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">kableExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>latex_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"scale_down"</span>,
                                                <span class="st">"striped"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="the-tb-data-results--md-tb" class="section level1">
<h1 class="hasAnchor">
<a href="#the-tb-data-results--md-tb" class="anchor"></a>The TB data results. <code>md-tb/</code>
</h1>
<div id="tables-3-and-4--tab3-4-data-eda-r" class="section level2">
<h2 class="hasAnchor">
<a href="#tables-3-and-4--tab3-4-data-eda-r" class="anchor"></a>Tables 3 and 4. <code>tab3-4-data-eda.R</code>
</h2>
<p>Expected run-time: ~seconds</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## SKG</span>
<span class="co">## June 21, 2021</span>
<span class="co">## Revisions for JCGS</span>
<span class="co">## Tables 3 and 4 in manuscript</span>
<span class="co">## Looking at distribution of cluster sizes</span>
<span class="co">## and a cross section of part of the data (cluster 15)</span>

<span class="va">rep_from_lib</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>

<span class="kw">if</span><span class="op">(</span><span class="va">rep_from_lib</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/skgallagher/InfectionTrees">InfectionTrees</a></span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">tb_clean</span><span class="op">)</span>

<span class="co">## Table 3</span>


<span class="co">### grouped individuals</span>
<span class="va">clust_sizes</span> <span class="op">&lt;-</span> <span class="va">tb_clean</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">clust_sizes</span><span class="op">$</span><span class="va">size</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">tab</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Cluster Size"</span>, <span class="st">"Freq."</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">tab</span><span class="op">)</span>,
      format <span class="op">=</span> <span class="st">"latex"</span>, row.names <span class="op">=</span> <span class="cn">TRUE</span>,
      booktabs <span class="op">=</span> <span class="cn">TRUE</span>,
      caption <span class="op">=</span> <span class="st">"Distribution of cluster size within the Maryland 2003-2009 TB data."</span>,
      label <span class="op">=</span> <span class="st">"data-clust-sizes"</span><span class="op">)</span>



<span class="co">## Table 4</span>

<span class="co">## Example cluster</span>
<span class="va">tb_clean</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span> <span class="va">group</span> <span class="op">==</span> <span class="fl">15</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">county</span>, <span class="va">rel_time</span>, <span class="va">hivstatus</span>, <span class="va">race</span>, <span class="va">sex</span>, <span class="va">spsmear</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">rel_time</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>county <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">county</span> <span class="op">==</span> <span class="st">"PRINCE GEORGES"</span>, <span class="st">"Prince Georges"</span>,
                           <span class="st">"Montgomery"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>format <span class="op">=</span> <span class="st">"latex"</span>,
          col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Cluster ID"</span>, <span class="st">"County"</span>, <span class="st">"Relative day"</span>,
                        <span class="st">"HIV status"</span>, <span class="st">"Race"</span>, <span class="st">"Sex"</span>, <span class="st">"Smear"</span><span class="op">)</span>,
          booktabs <span class="op">=</span> <span class="cn">TRUE</span>,
          caption <span class="op">=</span> <span class="st">"Example of individuals and some of their features within a single cluster"</span>, label <span class="op">=</span> <span class="st">"ex-clust"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>latex_options<span class="op">=</span><span class="st">"scale_down"</span><span class="op">)</span></code></pre></div>
<div id="tables-5-and-6-" class="section level3">
<h3 class="hasAnchor">
<a href="#tables-5-and-6-" class="anchor"></a>Tables 5 and 6.</h3>
<p>To get these results, we need to run the three models (base, multiple outside transmissions, and naive) and then combine them together.</p>
<div id="results-from-base-and-multiple-outside-transmissions-model--tb-data-base-and-mot-r" class="section level4">
<h4 class="hasAnchor">
<a href="#results-from-base-and-multiple-outside-transmissions-model--tb-data-base-and-mot-r" class="anchor"></a>Results from base and multiple outside transmissions model. <code>tb-data-base-and-mot.R</code>
</h4>
<p>Expected run-time: ~30 hours</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#!/usr/bin/env Rscript</span>

<span class="va">rep_from_lib</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>

<span class="kw">if</span><span class="op">(</span><span class="va">rep_from_lib</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/skgallagher/InfectionTrees">InfectionTrees</a></span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://forcats.tidyverse.org">forcats</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org">readr</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>




<span class="co">## --------------------------------------------------------------------------------------------------------</span>
<span class="va">clusters</span> <span class="op">&lt;-</span> <span class="va">tb_clean</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>smear <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">spsmear</span> <span class="op">==</span> <span class="st">"Positive"</span>,
                                 <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
                  cluster_id <span class="op">=</span> <span class="va">group</span>,
                  hiv_f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hivstatus</span> <span class="op">==</span> <span class="st">"Negative"</span>, <span class="st">"neg"</span>,
                          <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hivstatus</span> <span class="op">==</span> <span class="st">"Positive"</span>, <span class="st">"pos"</span>,
                                 <span class="st">"unk"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hiv_neg_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hiv_f</span> <span class="op">==</span> <span class="st">"neg"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
                  hiv_unk_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hiv_f</span> <span class="op">==</span> <span class="st">"unk"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rel_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">rel_time</span> <span class="op">/</span> <span class="fl">365</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cluster_size <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>race_f <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_collapse.html">fct_collapse</a></span><span class="op">(</span><span class="va">race</span>,
                                 white <span class="op">=</span> <span class="st">"White"</span>,
                                 black <span class="op">=</span> <span class="st">"Black or African American"</span>,
                                 asian <span class="op">=</span> <span class="st">"Asian"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>race_asian_white <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">race_f</span> <span class="op">==</span> <span class="st">"asian"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
           race_black_white <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">race_f</span> <span class="op">==</span> <span class="st">"black"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">cluster_id</span>, <span class="va">smear</span>,
           <span class="va">hiv_neg_pos</span>,
           <span class="va">hiv_unk_pos</span>,
           <span class="va">rel_time</span>,
           <span class="va">race_asian_white</span>,
           <span class="va">race_black_white</span>,
           <span class="va">cluster_size</span><span class="op">)</span>


<span class="co">## ----results = 'hide'------------------------------------------------------------------------------------</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">10000</span>
<span class="va">my_seed</span> <span class="op">&lt;-</span> <span class="fl">6172020</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">my_seed</span><span class="op">)</span>

<span class="co">## MODELS</span>
<span class="co">## models</span>
<span class="va">covariate_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="va">covariate_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
<span class="va">covariate_list</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"smear"</span>
<span class="va">covariate_list</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"smear"</span>,
                         <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span><span class="op">)</span>
<span class="va">covariate_list</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"smear"</span>,
                         <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>,
                         <span class="st">"rel_time"</span><span class="op">)</span>
<span class="va">covariate_list</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"smear"</span>,
                         <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>,
                         <span class="st">"rel_time"</span>,
                         <span class="st">"race_asian_white"</span>,
                         <span class="st">"race_black_white"</span><span class="op">)</span>

<span class="co">## Set up outputs</span>
<span class="va">loglike_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>model <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_list</span><span class="op">)</span>,
                         n_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">7</span><span class="op">)</span>,
                         loglike <span class="op">=</span> <span class="fl">0</span>,
                         aic <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="va">beta_mat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="fl">1</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">beta_mat1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Intercept"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">beta_mat1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Est."</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>, <span class="st">"SE"</span><span class="op">)</span>
<span class="va">beta_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_list</span><span class="op">)</span><span class="op">)</span>
<span class="va">beta_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">beta_mat1</span>
<span class="kw">for</span><span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_list</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,
                  ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="va">covariate_list</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Est."</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>, <span class="st">"SE"</span><span class="op">)</span>
    <span class="va">beta_list</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mat</span>
<span class="op">}</span>



<span class="co">## ----results = 'hide'------------------------------------------------------------------------------------</span>
<span class="va">t_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>

<span class="co">## Sample MC trees all at once</span>

<span class="va">t0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
<span class="co">## Sample all MC clusters at once for each of the 5 models</span>
<span class="va">mc_trees</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../../reference/sample_mc_trees.html">sample_mc_trees</a></span><span class="op">(</span><span class="va">clusters</span>,
                             B <span class="op">=</span> <span class="va">K</span>,
                             multiple_outside_transmissions <span class="op">=</span> <span class="cn">FALSE</span>,
                             covariate_names <span class="op">=</span> <span class="va">covariate_list</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_list</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t0</span><span class="op">)</span>


<span class="co">## Fit each of the models</span>

<span class="kw">for</span><span class="op">(</span><span class="va">jj</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">covariate_names</span> <span class="op">&lt;-</span> <span class="va">covariate_list</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Model:"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
        <span class="va">init_params</span> <span class="op">&lt;-</span> <span class="fl">0</span>
    <span class="op">}</span> <span class="kw">else</span><span class="op">{</span>
        <span class="va">init_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="co">## Optimize</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Optimizing"</span><span class="op">)</span>
    <span class="va">bds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">init_params</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">5</span><span class="op">)</span><span class="op">{</span>
        <span class="va">bds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">init_params</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="va">lower_bds</span> <span class="op">&lt;-</span> <span class="va">bds</span>
    <span class="va">upper_bds</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">bds</span>
    <span class="va">cov_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/covariate_df_to_mat.html">covariate_df_to_mat</a></span><span class="op">(</span><span class="va">mc_trees</span>,
                                   cov_names <span class="op">=</span> <span class="va">covariate_names</span><span class="op">)</span>

    <span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
    <span class="va">best_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span>par <span class="op">=</span> <span class="va">init_params</span>,
                         fn <span class="op">=</span> <span class="va">general_loglike</span>,
                         mc_trees <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">mc_trees</span><span class="op">)</span>,
                         return_neg <span class="op">=</span> <span class="cn">TRUE</span>,
                         cov_mat <span class="op">=</span> <span class="va">cov_mat</span>,
                         cov_names <span class="op">=</span> <span class="va">covariate_names</span>,
                         use_outsider_prob <span class="op">=</span> <span class="cn">FALSE</span>,
                         multiple_outside_transmissions <span class="op">=</span> <span class="cn">FALSE</span>,
                         method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
                         lower <span class="op">=</span> <span class="va">lower_bds</span>,
                         upper <span class="op">=</span> <span class="va">upper_bds</span>,
                         hessian <span class="op">=</span> <span class="cn">TRUE</span>
                         <span class="op">)</span>
    <span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t1</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Optimization time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="va">t2</span> <span class="op">/</span> <span class="fl">60</span>, <span class="fl">3</span><span class="op">)</span>,
                <span class="st">"min"</span><span class="op">)</span><span class="op">)</span>

    <span class="va">beta_list</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span>
    <span class="va">beta_list</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">hessian</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co">## SE from Fisher info</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"best params:"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">beta_list</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
    <span class="va">loglike_df</span><span class="op">$</span><span class="va">loglike</span><span class="op">[</span><span class="va">jj</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">best_params</span><span class="op">$</span><span class="va">val</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Total time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t_init</span><span class="op">)</span>  <span class="op">/</span> <span class="fl">3600</span>, <span class="fl">3</span><span class="op">)</span>,
                <span class="st">"hrs"</span><span class="op">)</span><span class="op">)</span>


<span class="op">}</span>



<span class="co">## --------------------------------------------------------------------------------------------------------</span>

<span class="va">loglike_df</span> <span class="op">&lt;-</span> <span class="va">loglike_df</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>aic <span class="op">=</span> <span class="op">-</span><span class="va">loglike</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">n_params</span>,
           model <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>


<span class="va">loglike_df</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span>,
                     col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Model"</span>, <span class="st">"# params."</span>, <span class="st">"Log like."</span>, <span class="st">"AIC"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>bootstrap_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"condensed"</span>, <span class="st">"hover"</span>, <span class="st">"striped"</span>, <span class="st">"responsive"</span><span class="op">)</span>,
                  full_width <span class="op">=</span> <span class="cn">FALSE</span>, position <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>



<span class="co">## --------------------------------------------------------------------------------------------------------</span>
<span class="va">beta_list</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>bootstrap_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"condensed"</span>, <span class="st">"hover"</span>, <span class="st">"striped"</span>, <span class="st">"responsive"</span><span class="op">)</span>,
                  full_width <span class="op">=</span> <span class="cn">FALSE</span>, position <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>



<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>beta_list <span class="op">=</span> <span class="va">beta_list</span>,
             loglike_df <span class="op">=</span> <span class="va">loglike_df</span><span class="op">)</span>,
        <span class="st">"base-results.RDS"</span><span class="op">)</span>


<span class="co">## ----results = 'hide'------------------------------------------------------------------------------------</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">10000</span>
<span class="va">my_seed</span> <span class="op">&lt;-</span> <span class="fl">24</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">my_seed</span><span class="op">)</span>

<span class="co">## MODELS</span>
<span class="co">## models</span>
<span class="va">covariate_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="va">covariate_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
<span class="va">covariate_list</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"smear"</span>
<span class="va">covariate_list</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"smear"</span>,
                         <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span><span class="op">)</span>
<span class="va">covariate_list</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"smear"</span>,
                         <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>,
                         <span class="st">"rel_time"</span><span class="op">)</span>
<span class="va">covariate_list</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"smear"</span>,
                         <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>,
                         <span class="st">"rel_time"</span>,
                         <span class="st">"race_asian_white"</span>,
                         <span class="st">"race_black_white"</span><span class="op">)</span>

<span class="co">## Set up outputs</span>
<span class="va">loglike_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>model <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_list</span><span class="op">)</span>,
                         n_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">7</span><span class="op">)</span>,
                         loglike <span class="op">=</span> <span class="fl">0</span>,
                         aic <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="va">beta_mat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="fl">1</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">beta_mat1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Intercept"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">beta_mat1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Est."</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>, <span class="st">"SE"</span><span class="op">)</span>
<span class="va">beta_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_list</span><span class="op">)</span><span class="op">)</span>
<span class="va">beta_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">beta_mat1</span>
<span class="kw">for</span><span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_list</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,
                  ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="va">covariate_list</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Est."</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>, <span class="st">"SE"</span><span class="op">)</span>
    <span class="va">beta_list</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mat</span>
<span class="op">}</span>



<span class="co">## ----results = 'hide'------------------------------------------------------------------------------------</span>
<span class="va">t_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>

<span class="co">## Sample MC trees all at once</span>

<span class="va">t0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
<span class="co">## Sample all MC clusters at once for each of the 5 models</span>
<span class="va">mc_trees</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../../reference/sample_mc_trees.html">sample_mc_trees</a></span><span class="op">(</span><span class="va">clusters</span>,
                             B <span class="op">=</span> <span class="va">K</span>,
                             multiple_outside_transmissions <span class="op">=</span> <span class="cn">TRUE</span>,
                             covariate_names <span class="op">=</span> <span class="va">covariate_list</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_list</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t0</span><span class="op">)</span>


<span class="co">## Fit each of the models</span>

<span class="kw">for</span><span class="op">(</span><span class="va">jj</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">covariate_names</span> <span class="op">&lt;-</span> <span class="va">covariate_list</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Model:"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
        <span class="va">init_params</span> <span class="op">&lt;-</span> <span class="fl">0</span>
    <span class="op">}</span> <span class="kw">else</span><span class="op">{</span>
        <span class="va">init_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="co">## Optimize</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Optimizing"</span><span class="op">)</span>
    <span class="va">bds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">init_params</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">5</span><span class="op">)</span><span class="op">{</span>
        <span class="va">bds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">init_params</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="va">lower_bds</span> <span class="op">&lt;-</span> <span class="va">bds</span>
    <span class="va">upper_bds</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">bds</span>
    <span class="va">cov_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/covariate_df_to_mat.html">covariate_df_to_mat</a></span><span class="op">(</span><span class="va">mc_trees</span>,
                                   cov_names <span class="op">=</span> <span class="va">covariate_names</span><span class="op">)</span>

    <span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
    <span class="va">best_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span>par <span class="op">=</span> <span class="va">init_params</span>,
                         fn <span class="op">=</span> <span class="va">general_loglike</span>,
                         mc_trees <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">mc_trees</span><span class="op">)</span>,
                         return_neg <span class="op">=</span> <span class="cn">TRUE</span>,
                         cov_mat <span class="op">=</span> <span class="va">cov_mat</span>,
                         cov_names <span class="op">=</span> <span class="va">covariate_names</span>,
                         use_outsider_prob <span class="op">=</span> <span class="cn">FALSE</span>,
                         multiple_outside_transmissions <span class="op">=</span> <span class="cn">TRUE</span>,
                         method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
                         lower <span class="op">=</span> <span class="va">lower_bds</span>,
                         upper <span class="op">=</span> <span class="va">upper_bds</span>,
                         hessian <span class="op">=</span> <span class="cn">TRUE</span>
                         <span class="op">)</span>
    <span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t1</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Optimization time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="va">t2</span> <span class="op">/</span> <span class="fl">60</span>, <span class="fl">3</span><span class="op">)</span>,
                <span class="st">"min"</span><span class="op">)</span><span class="op">)</span>

    <span class="va">beta_list</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span>
    <span class="va">beta_list</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">hessian</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co">## SE from Fisher info</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"best params:"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">beta_list</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
    <span class="va">loglike_df</span><span class="op">$</span><span class="va">loglike</span><span class="op">[</span><span class="va">jj</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">best_params</span><span class="op">$</span><span class="va">val</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Total time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t_init</span><span class="op">)</span>  <span class="op">/</span> <span class="fl">3600</span>, <span class="fl">3</span><span class="op">)</span>,
                <span class="st">"hrs"</span><span class="op">)</span><span class="op">)</span>


<span class="op">}</span>



<span class="co">## --------------------------------------------------------------------------------------------------------</span>

<span class="va">loglike_df</span> <span class="op">&lt;-</span> <span class="va">loglike_df</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>aic <span class="op">=</span> <span class="op">-</span><span class="va">loglike</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">n_params</span>,
           model <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>


<span class="va">loglike_df</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span>,
                     col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Model"</span>, <span class="st">"# params."</span>, <span class="st">"Log like."</span>, <span class="st">"AIC"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>bootstrap_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"condensed"</span>, <span class="st">"hover"</span>, <span class="st">"striped"</span>, <span class="st">"responsive"</span><span class="op">)</span>,
                  full_width <span class="op">=</span> <span class="cn">FALSE</span>, position <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>



<span class="co">## --------------------------------------------------------------------------------------------------------</span>
<span class="va">beta_list</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>bootstrap_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"condensed"</span>, <span class="st">"hover"</span>, <span class="st">"striped"</span>, <span class="st">"responsive"</span><span class="op">)</span>,
                  full_width <span class="op">=</span> <span class="cn">FALSE</span>, position <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>beta_list <span class="op">=</span> <span class="va">beta_list</span>,
             loglike_df <span class="op">=</span> <span class="va">loglike_df</span><span class="op">)</span>,
        <span class="st">"mot-results.RDS"</span><span class="op">)</span></code></pre></div>
</div>
<div id="bootstrap-standard-error-for-base-and-multiple-outside-transmissions-model--bootstrap-sims-r" class="section level4">
<h4 class="hasAnchor">
<a href="#bootstrap-standard-error-for-base-and-multiple-outside-transmissions-model--bootstrap-sims-r" class="anchor"></a>Bootstrap standard error for base and multiple outside transmissions model. <code>bootstrap-sims.R</code>
</h4>
<p>Expected run-time: 5 days for the longest loop. Each loop was run in parallel on the NIAID supercomputer, Biowulf.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#!/usr/bin/env Rscript</span>

<span class="co">## SKG</span>
<span class="co">## Aug. 26, 2020</span>
<span class="co">## Bootstrap simulations to estimate standard error for the data</span>
<span class="co">## 5 different models</span>
<span class="co">## Updated June 22, 2021</span>







<span class="co">## Load libraries and data</span>
<span class="kw">if</span><span class="op">(</span><span class="st">"InfectionTrees"</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/remove.packages.html">remove.packages</a></span><span class="op">(</span><span class="st">"InfectionTrees"</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"skgallagher/InfectionTrees"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/skgallagher/InfectionTrees">InfectionTrees</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">tb_clean</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">use_mot</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span>
    <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">use_mot</span>,
                  <span class="st">"Multiple Outside Transmissions"</span>,
                  <span class="st">"Base model"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>

    <span class="co">## simulation parameters</span>
    <span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">10000</span> <span class="co"># of MC trees to draw for each cluster</span>
    <span class="va">n_models</span> <span class="op">&lt;-</span> <span class="fl">1</span>
    <span class="va">n_boot</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># number of bootstrap simulations</span>
    <span class="va">my_seed</span> <span class="op">&lt;-</span> <span class="fl">8262020</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">use_mot</span>, <span class="fl">1000</span>, <span class="fl">0</span><span class="op">)</span>
    <span class="co">## Each inner loop takes ~1 hr</span>

    <span class="co">## Format original clusters to useful variables</span>

    <span class="va">orig_clusters</span> <span class="op">&lt;-</span>  <span class="va">tb_clean</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>smear <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">spsmear</span> <span class="op">==</span> <span class="st">"Positive"</span>,
                                     <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
                      cluster_id <span class="op">=</span> <span class="va">group</span>,
                      hiv_f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hivstatus</span> <span class="op">==</span> <span class="st">"Negative"</span>, <span class="st">"neg"</span>,
                                     <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hivstatus</span> <span class="op">==</span> <span class="st">"Positive"</span>, <span class="st">"pos"</span>,
                                            <span class="st">"unk"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hiv_neg_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hiv_f</span> <span class="op">==</span> <span class="st">"neg"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
               hiv_unk_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hiv_f</span> <span class="op">==</span> <span class="st">"unk"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rel_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">rel_time</span> <span class="op">/</span> <span class="fl">365</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cluster_size <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>race_f <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_collapse.html">fct_collapse</a></span><span class="op">(</span><span class="va">race</span>,
                                 white <span class="op">=</span> <span class="st">"White"</span>,
                                 black <span class="op">=</span> <span class="st">"Black or African American"</span>,
                                 asian <span class="op">=</span> <span class="st">"Asian"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>race_asian_white <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">race_f</span> <span class="op">==</span> <span class="st">"asian"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
           race_black_white <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">race_f</span> <span class="op">==</span> <span class="st">"black"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">cluster_id</span>, <span class="va">smear</span>,
           <span class="va">hiv_neg_pos</span>,
           <span class="va">hiv_unk_pos</span>,
           <span class="va">rel_time</span>,
           <span class="va">race_asian_white</span>,
           <span class="va">race_black_white</span>,
           <span class="va">cluster_size</span><span class="op">)</span>

    <span class="co">## models</span>

    <span class="va">covariate_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"smear"</span>,
                             <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>,
                         <span class="st">"rel_time"</span><span class="op">)</span>
    <span class="va">beta_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,
                  nrow <span class="op">=</span> <span class="va">n_boot</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">beta_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="va">covariate_names</span><span class="op">)</span>

    <span class="va">t_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
    <span class="kw">for</span><span class="op">(</span><span class="va">nn</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_boot</span><span class="op">)</span><span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">my_seed</span> <span class="op">+</span> <span class="va">nn</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Bootstrap simulation %d"</span>, <span class="va">nn</span><span class="op">)</span><span class="op">)</span>

        <span class="co">## Sample a bootstrap cluster</span>
        <span class="va">b_clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/bootstrap_clusters.html">bootstrap_clusters</a></span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">orig_clusters</span><span class="op">)</span>

        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"sampling  %d MC trees"</span>, <span class="va">K</span><span class="op">)</span><span class="op">)</span>
        <span class="co">## sample MC trees</span>

        <span class="va">t0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
        <span class="co">## Sample all MC clusters at once for each of the 5 models</span>
        <span class="va">mc_trees</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../../reference/sample_mc_trees.html">sample_mc_trees</a></span><span class="op">(</span><span class="va">b_clusters</span>,
                                     B <span class="op">=</span> <span class="va">K</span>,
                                     multiple_outside_transmissions <span class="op">=</span> <span class="va">use_mot</span>,
                                     covariate_names <span class="op">=</span> <span class="va">covariate_names</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t0</span><span class="op">)</span>

        
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Model:"</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span>
        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
            <span class="va">init_params</span> <span class="op">&lt;-</span> <span class="fl">0</span>
        <span class="op">}</span> <span class="kw">else</span><span class="op">{</span>
            <span class="va">init_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
        <span class="op">}</span>
        <span class="co">## Optimize</span>
        
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Optimizing"</span><span class="op">)</span>
        <span class="va">bds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">init_params</span><span class="op">)</span><span class="op">)</span>
        <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">5</span><span class="op">)</span><span class="op">{</span>
            <span class="va">bds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">init_params</span><span class="op">)</span><span class="op">)</span>
        <span class="op">}</span>
        <span class="va">lower_bds</span> <span class="op">&lt;-</span> <span class="va">bds</span>
        <span class="va">upper_bds</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">bds</span>
        <span class="va">cov_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/covariate_df_to_mat.html">covariate_df_to_mat</a></span><span class="op">(</span><span class="va">mc_trees</span>,
                                       cov_names <span class="op">=</span> <span class="va">covariate_names</span><span class="op">)</span>
        <span class="co">## Now with data.table</span>
        <span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
        <span class="va">best_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span>par <span class="op">=</span> <span class="va">init_params</span>,
                             fn <span class="op">=</span> <span class="va">general_loglike</span>,
                             mc_trees <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">mc_trees</span><span class="op">)</span>,
                             return_neg <span class="op">=</span> <span class="cn">TRUE</span>,
                             cov_mat <span class="op">=</span> <span class="va">cov_mat</span>,
                             cov_names <span class="op">=</span> <span class="va">covariate_names</span>,
                             use_outsider_prob <span class="op">=</span> <span class="cn">FALSE</span>,
                             multiple_outside_transmissions <span class="op">=</span> <span class="va">use_mot</span>,
                             method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
                             lower <span class="op">=</span> <span class="va">lower_bds</span>,
                             upper <span class="op">=</span> <span class="va">upper_bds</span>
                             <span class="op">)</span>
        <span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t1</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Optimization time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="va">t2</span> <span class="op">/</span> <span class="fl">60</span>, <span class="fl">3</span><span class="op">)</span>,
                    <span class="st">"min"</span><span class="op">)</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"best params:"</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">par</span><span class="op">)</span>
        <span class="va">beta_mat</span><span class="op">[</span><span class="va">nn</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Total time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t_init</span><span class="op">)</span>  <span class="op">/</span> <span class="fl">3600</span>, <span class="fl">3</span><span class="op">)</span>,
                    <span class="st">"hrs"</span><span class="op">)</span><span class="op">)</span>

    <span class="op">}</span>
    

    <span class="va">se_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">beta_mat</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Bootstrap sample error matrices"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">se_vec</span><span class="op">)</span>
    
    <span class="va">output_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>covariate_names <span class="op">=</span> <span class="va">covariate_names</span>,
                        se_vec <span class="op">=</span> <span class="va">se_vec</span>,
                        beta_mat <span class="op">=</span> <span class="va">beta_mat</span>,
                        n_boot <span class="op">=</span> <span class="va">n_boot</span>,
                        mot <span class="op">=</span> <span class="va">use_mot</span><span class="op">)</span>

    <span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
    <span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">" "</span>, <span class="st">"_"</span>, <span class="va">current_time</span><span class="op">)</span>
    <span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">":"</span>, <span class="st">"."</span>, <span class="va">current_time</span><span class="op">)</span>
    <span class="va">fn_base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"bootstrap_sims_"</span>,
                      <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">use_mot</span>, <span class="st">"mot_"</span>, <span class="st">"base_"</span><span class="op">)</span>,
                      <span class="va">current_time</span>, <span class="st">".RDS"</span><span class="op">)</span>

    <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">output_list</span>, <span class="va">fn_base</span><span class="op">)</span>


<span class="op">}</span></code></pre></div>
</div>
<div id="naive-model-results--data-naive-model-r" class="section level4">
<h4 class="hasAnchor">
<a href="#naive-model-results--data-naive-model-r" class="anchor"></a>Naive model results. <code>data-naive-model.R</code>
</h4>
<p>Expected run-time: ~seconds</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## SKG</span>
<span class="co">## Testing out model where transmission tree is determined by infection order</span>

<span class="co">## Load libraries and data</span>
<span class="va">rep_from_lib</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>

<span class="kw">if</span><span class="op">(</span><span class="va">rep_from_lib</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/skgallagher/InfectionTrees">InfectionTrees</a></span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">tb_clean</span><span class="op">)</span>
<span class="co">## library(optimParallel)</span>
<span class="co">#</span>
<span class="co">## Set up clusters</span>
<span class="co">## cl &lt;- makeCluster(5, type = "FORK")</span>
<span class="co">##setDefaultCluster(cl)</span>

<span class="va">my_seed</span> <span class="op">&lt;-</span> <span class="fl">6172020</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">my_seed</span><span class="op">)</span>

<span class="va">t0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>

<span class="co">## Format the data for all the variables</span>

<span class="co">## I'm filling in the Unknown with a negative smear</span>
<span class="co">## Should later check to see if results are changed with positive</span>
<span class="va">tb_sub</span> <span class="op">&lt;-</span> <span class="va">tb_clean</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>smear <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">spsmear</span> <span class="op">==</span> <span class="st">"Positive"</span>,
                                     <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
                      cluster_id <span class="op">=</span> <span class="va">group</span>,
                      hiv_f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hivstatus</span> <span class="op">==</span> <span class="st">"Negative"</span>, <span class="st">"neg"</span>,
                                     <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hivstatus</span> <span class="op">==</span> <span class="st">"Positive"</span>, <span class="st">"pos"</span>,
                                            <span class="st">"unk"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hiv_neg_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hiv_f</span> <span class="op">==</span> <span class="st">"neg"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
               hiv_unk_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hiv_f</span> <span class="op">==</span> <span class="st">"unk"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rel_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">rel_time</span> <span class="op">/</span> <span class="fl">365</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cluster_size <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>race_f <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_collapse.html">fct_collapse</a></span><span class="op">(</span><span class="va">race</span>,
                                 white <span class="op">=</span> <span class="st">"White"</span>,
                                 black <span class="op">=</span> <span class="st">"Black or African American"</span>,
                                 asian <span class="op">=</span> <span class="st">"Asian"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>race_asian_white <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">race_f</span> <span class="op">==</span> <span class="st">"asian"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
           race_black_white <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">race_f</span> <span class="op">==</span> <span class="st">"black"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">cluster_id</span>, <span class="va">smear</span>,
           <span class="va">hiv_neg_pos</span>,
           <span class="va">hiv_unk_pos</span>,
           <span class="va">rel_time</span>,
           <span class="va">race_asian_white</span>,
           <span class="va">race_black_white</span>,
           <span class="va">cluster_size</span><span class="op">)</span>
<span class="va">tb_orig</span> <span class="op">&lt;-</span> <span class="va">tb_sub</span>




<span class="va">naive_loglike</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">inf_params</span>, <span class="va">dt</span>,
                          <span class="va">covariate_names</span>, <span class="va">cov_mat</span>,
                          <span class="va">return_neg</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">{</span>

    <span class="va">dt</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span>, <span class="va">prob_inf</span> <span class="op">:=</span>
                   <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">cov_mat</span> <span class="op">%*%</span> <span class="va">inf_params</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
    <span class="co">## Trying out data.table</span>
    <span class="va">loglike_df</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span>,
                     <span class="fu">.</span><span class="op">(</span>loglike <span class="op">=</span> <span class="fu">naive_cluster_loglike</span><span class="op">(</span><span class="va">prob_inf</span>, <span class="va">rel_time</span><span class="op">)</span><span class="op">)</span>,
                            by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span><span class="op">]</span>
    <span class="va">loglike</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">loglike_df</span><span class="op">$</span><span class="va">loglike</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="va">return_neg</span><span class="op">)</span> <span class="va">loglike</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">loglike</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">loglike</span><span class="op">)</span>
    


<span class="op">}</span>

<span class="co"># cluster contains column datecoll which is the date of collection</span>
<span class="va">naive_cluster_loglike</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prob_inf</span>, <span class="va">datecoll</span><span class="op">)</span><span class="op">{</span>
    <span class="va">last_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span><span class="va">datecoll</span><span class="op">)</span>
    <span class="va">probs</span> <span class="op">&lt;-</span> <span class="va">prob_inf</span><span class="op">[</span><span class="op">-</span><span class="va">last_ind</span><span class="op">]</span>
    <span class="va">loglike</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">probs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">prob_inf</span><span class="op">)</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">loglike</span><span class="op">)</span>

<span class="op">}</span>

<span class="va">naive_loglike_wrapper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">inf_params</span>, <span class="va">dt</span>,
                                  <span class="va">covariate_names</span>,
                                  <span class="va">cov_mat</span>,
                                  <span class="va">beta_index</span>,
                                  <span class="va">max_loglike</span>,
                                  <span class="va">chi_stat</span> <span class="op">=</span> <span class="fl">1.92</span><span class="op">)</span><span class="op">{</span>
    <span class="va">inf_params</span><span class="op">[</span><span class="va">beta_index</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span>
    <span class="fu">naive_loglike</span><span class="op">(</span><span class="va">inf_params</span>, <span class="va">dt</span>,
                          <span class="va">covariate_names</span>, <span class="va">cov_mat</span>,
                  return_neg <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> <span class="va">chi_stat</span> <span class="op">-</span> <span class="va">max_loglike</span>

<span class="op">}</span>

<span class="co">######################3</span>
<span class="co">## PERMUTE relative time within clusters</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">7272020</span><span class="op">)</span>
<span class="va">beta1_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">jj</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">{</span>
    <span class="va">tb_sub</span> <span class="op">&lt;-</span> <span class="va">tb_orig</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rel_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">rel_time</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>

    <span class="va">covariate_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"smear"</span>, <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span><span class="op">)</span>
    <span class="va">cov_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/covariate_df_to_mat.html">covariate_df_to_mat</a></span><span class="op">(</span><span class="va">tb_sub</span>,
                                   cov_names <span class="op">=</span> <span class="va">covariate_names</span><span class="op">)</span>
    <span class="va">init_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
    <span class="va">bds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
    <span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
    <span class="va">best_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span>par <span class="op">=</span> <span class="va">init_params</span>,
                         fn <span class="op">=</span> <span class="va">naive_loglike</span>,
                         dt <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">tb_sub</span><span class="op">)</span>,
                         return_neg <span class="op">=</span> <span class="cn">TRUE</span>,
                         cov_mat <span class="op">=</span> <span class="va">cov_mat</span>,
                         covariate_names <span class="op">=</span> <span class="va">covariate_names</span>,
                         method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
                         lower <span class="op">=</span> <span class="va">bds</span>,
                         upper <span class="op">=</span> <span class="op">-</span><span class="va">bds</span>
                         <span class="op">)</span>
    <span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t1</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Optimization time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="va">t2</span> <span class="op">/</span> <span class="fl">60</span>, <span class="fl">3</span><span class="op">)</span>,
                <span class="st">"min"</span><span class="op">)</span><span class="op">)</span>

    <span class="co">## Likelihood profile</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Likelihood profile"</span><span class="op">)</span>

    <span class="va">ci_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, ncol <span class="op">=</span> <span class="fl">2</span>,
                     nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">par</span><span class="op">)</span><span class="op">)</span>

    <span class="va">ci_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, ncol <span class="op">=</span> <span class="fl">2</span>,
                     nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">par</span><span class="op">)</span><span class="op">)</span>

    <span class="kw">for</span><span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">ci_mat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
        <span class="va">max_loglike</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">best_params</span><span class="op">$</span><span class="va">value</span>
        <span class="va">best_pars</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span>
        <span class="va">lower</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html">uniroot</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">naive_loglike_wrapper</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">best_pars</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span> <span class="op">-</span> <span class="fl">3</span>, <span class="va">best_pars</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span><span class="op">)</span>,
                         max_loglike <span class="op">=</span> <span class="va">max_loglike</span>,
                         inf_params <span class="op">=</span> <span class="va">best_pars</span>,
                         beta_index <span class="op">=</span> <span class="va">ii</span>,
                         dt <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">tb_sub</span><span class="op">)</span>,
                         covariate_names <span class="op">=</span> <span class="va">covariate_names</span>,
                         cov_mat <span class="op">=</span> <span class="va">cov_mat</span>,
                         chi_stat <span class="op">=</span> <span class="fl">1.92</span><span class="op">)</span>
        <span class="co">##</span>
        <span class="va">upper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html">uniroot</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">naive_loglike_wrapper</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">best_pars</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span>, <span class="va">best_pars</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span> <span class="op">+</span> <span class="fl">3</span><span class="op">)</span>,
                         max_loglike <span class="op">=</span> <span class="va">max_loglike</span>,
                         inf_params <span class="op">=</span> <span class="va">best_pars</span>,
                         beta_index <span class="op">=</span> <span class="va">ii</span>,
                         dt <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">tb_sub</span><span class="op">)</span>,
                         covariate_names <span class="op">=</span> <span class="va">covariate_names</span>,
                         cov_mat <span class="op">=</span> <span class="va">cov_mat</span>,
                         chi_stat <span class="op">=</span> <span class="fl">1.92</span><span class="op">)</span>

        <span class="va">ci_mat</span><span class="op">[</span><span class="va">ii</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">lower</span><span class="op">$</span><span class="va">root</span>
        <span class="va">ci_mat</span><span class="op">[</span><span class="va">ii</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">upper</span><span class="op">$</span><span class="va">root</span>
    <span class="op">}</span>
    <span class="va">est_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">best_pars</span>, <span class="va">ci_mat</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">est_pars</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>,
                            <span class="va">covariate_names</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">est_pars</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Mean"</span>, <span class="st">"Lower95"</span>, <span class="st">"Uppper95"</span><span class="op">)</span>
    <span class="va">beta1_vec</span><span class="op">[</span><span class="va">jj</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">est_pars</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">-</span><span class="va">best_params</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">est_pars</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">#######################################3</span>

<span class="co">######################3</span>
<span class="co">## ORIGINAL</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">7272020</span><span class="op">)</span>
<span class="va">beta1_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">jj</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span>
    <span class="va">tb_sub</span> <span class="op">&lt;-</span> <span class="va">tb_orig</span> 

    <span class="va">covariate_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"smear"</span>, <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>, <span class="st">"rel_time"</span><span class="op">)</span>
    <span class="va">cov_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/covariate_df_to_mat.html">covariate_df_to_mat</a></span><span class="op">(</span><span class="va">tb_sub</span>,
                                   cov_names <span class="op">=</span> <span class="va">covariate_names</span><span class="op">)</span>
    <span class="va">init_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
    <span class="va">bds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
    <span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
    <span class="va">best_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span>par <span class="op">=</span> <span class="va">init_params</span>,
                         fn <span class="op">=</span> <span class="va">naive_loglike</span>,
                         dt <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">tb_sub</span><span class="op">)</span>,
                         return_neg <span class="op">=</span> <span class="cn">TRUE</span>,
                         cov_mat <span class="op">=</span> <span class="va">cov_mat</span>,
                         covariate_names <span class="op">=</span> <span class="va">covariate_names</span>,
                         method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
                         lower <span class="op">=</span> <span class="va">bds</span>,
                         upper <span class="op">=</span> <span class="op">-</span><span class="va">bds</span>,
                         hessian <span class="op">=</span> <span class="cn">TRUE</span>
                         <span class="op">)</span>
    <span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t1</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Optimization time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="va">t2</span> <span class="op">/</span> <span class="fl">60</span>, <span class="fl">3</span><span class="op">)</span>,
                <span class="st">"min"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">hessian</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

    <span class="va">ci_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, ncol <span class="op">=</span> <span class="fl">2</span>,
                     nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">par</span><span class="op">)</span><span class="op">)</span>

    <span class="va">ci_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, ncol <span class="op">=</span> <span class="fl">2</span>,
                     nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">par</span><span class="op">)</span><span class="op">)</span>

    <span class="va">ci_mat</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>
    <span class="va">ci_mat</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>
   
    <span class="va">est_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">best_pars</span>, <span class="va">ci_mat</span>, <span class="va">se</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">est_pars</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>,
                            <span class="va">covariate_names</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">est_pars</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Mean"</span>, <span class="st">"Lower95"</span>, <span class="st">"Uppper95"</span>, <span class="st">"SE"</span><span class="op">)</span>
    <span class="va">beta1_vec</span><span class="op">[</span><span class="va">jj</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">est_pars</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">-</span><span class="va">best_params</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">est_pars</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">est_pars</span>, <span class="st">"naive-tab.RDS"</span><span class="op">)</span></code></pre></div>
</div>
<div id="naive-model-bootstrap-error--data-naive-boot-r" class="section level4">
<h4 class="hasAnchor">
<a href="#naive-model-bootstrap-error--data-naive-boot-r" class="anchor"></a>Naive model bootstrap error. <code>data-naive-boot.R</code>
</h4>
<p>Expected run-time: ~15 minutes</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## SKG</span>
<span class="co">## Testing out model where transmission tree is determined by infection order</span>
<span class="co">## Updated June 23, 2021 to add a bootstrap SE</span>

<span class="co">## Load libraries and data</span>
<span class="va">rep_from_lib</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>

<span class="kw">if</span><span class="op">(</span><span class="va">rep_from_lib</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/skgallagher/InfectionTrees">InfectionTrees</a></span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">tb_clean</span><span class="op">)</span>

<span class="va">my_seed</span> <span class="op">&lt;-</span> <span class="fl">6172021</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">my_seed</span><span class="op">)</span>

<span class="va">t0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>

<span class="co">## Format the data for all the variables</span>

<span class="co">## I'm filling in the Unknown with a negative smear</span>
<span class="co">## Should later check to see if results are changed with positive</span>
<span class="va">tb_sub</span> <span class="op">&lt;-</span> <span class="va">tb_clean</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>smear <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">spsmear</span> <span class="op">==</span> <span class="st">"Positive"</span>,
                                     <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
                      cluster_id <span class="op">=</span> <span class="va">group</span>,
                      hiv_f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hivstatus</span> <span class="op">==</span> <span class="st">"Negative"</span>, <span class="st">"neg"</span>,
                                     <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hivstatus</span> <span class="op">==</span> <span class="st">"Positive"</span>, <span class="st">"pos"</span>,
                                            <span class="st">"unk"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hiv_neg_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hiv_f</span> <span class="op">==</span> <span class="st">"neg"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
               hiv_unk_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hiv_f</span> <span class="op">==</span> <span class="st">"unk"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rel_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">rel_time</span> <span class="op">/</span> <span class="fl">365</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cluster_size <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>race_f <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_collapse.html">fct_collapse</a></span><span class="op">(</span><span class="va">race</span>,
                                 white <span class="op">=</span> <span class="st">"White"</span>,
                                 black <span class="op">=</span> <span class="st">"Black or African American"</span>,
                                 asian <span class="op">=</span> <span class="st">"Asian"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>race_asian_white <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">race_f</span> <span class="op">==</span> <span class="st">"asian"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
           race_black_white <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">race_f</span> <span class="op">==</span> <span class="st">"black"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">cluster_id</span>, <span class="va">smear</span>,
           <span class="va">hiv_neg_pos</span>,
           <span class="va">hiv_unk_pos</span>,
           <span class="va">rel_time</span>,
           <span class="va">race_asian_white</span>,
           <span class="va">race_black_white</span>,
           <span class="va">cluster_size</span><span class="op">)</span>
<span class="va">tb_orig</span> <span class="op">&lt;-</span> <span class="va">tb_sub</span>




<span class="va">naive_loglike</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">inf_params</span>, <span class="va">dt</span>,
                          <span class="va">covariate_names</span>, <span class="va">cov_mat</span>,
                          <span class="va">return_neg</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">{</span>

    <span class="va">dt</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span>, <span class="va">prob_inf</span> <span class="op">:=</span>
                   <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">cov_mat</span> <span class="op">%*%</span> <span class="va">inf_params</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
    <span class="co">## Trying out data.table</span>
    <span class="va">loglike_df</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span>,
                     <span class="fu">.</span><span class="op">(</span>loglike <span class="op">=</span> <span class="fu">naive_cluster_loglike</span><span class="op">(</span><span class="va">prob_inf</span>, <span class="va">rel_time</span><span class="op">)</span><span class="op">)</span>,
                            by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span><span class="op">]</span>
    <span class="va">loglike</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">loglike_df</span><span class="op">$</span><span class="va">loglike</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="va">return_neg</span><span class="op">)</span> <span class="va">loglike</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">loglike</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">loglike</span><span class="op">)</span>
    


<span class="op">}</span>

<span class="co"># cluster contains column datecoll which is the date of collection</span>
<span class="va">naive_cluster_loglike</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prob_inf</span>, <span class="va">datecoll</span><span class="op">)</span><span class="op">{</span>
    <span class="va">last_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span><span class="va">datecoll</span><span class="op">)</span>
    <span class="va">probs</span> <span class="op">&lt;-</span> <span class="va">prob_inf</span><span class="op">[</span><span class="op">-</span><span class="va">last_ind</span><span class="op">]</span>
    <span class="va">loglike</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">probs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">prob_inf</span><span class="op">)</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">loglike</span><span class="op">)</span>

<span class="op">}</span>



<span class="co">######################3</span>
<span class="co">## ORIGINAL</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">7272021</span><span class="op">)</span>
<span class="va">beta1_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">100</span>


<span class="va">beta_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">B</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="va">cov_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">B</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">jj</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">B</span><span class="op">)</span><span class="op">{</span>

    <span class="co">## boot strap orig data</span>
    <span class="va">tb_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/bootstrap_clusters.html">bootstrap_clusters</a></span><span class="op">(</span><span class="va">tb_orig</span><span class="op">)</span>
    
   

    <span class="va">covariate_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"smear"</span>, <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>, <span class="st">"rel_time"</span><span class="op">)</span>
    <span class="va">cov_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/covariate_df_to_mat.html">covariate_df_to_mat</a></span><span class="op">(</span><span class="va">tb_sub</span>,
                                   cov_names <span class="op">=</span> <span class="va">covariate_names</span><span class="op">)</span>
    <span class="va">init_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
    <span class="va">bds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">covariate_names</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
    <span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
    <span class="va">best_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span>par <span class="op">=</span> <span class="va">init_params</span>,
                         fn <span class="op">=</span> <span class="va">naive_loglike</span>,
                         dt <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">tb_sub</span><span class="op">)</span>,
                         return_neg <span class="op">=</span> <span class="cn">TRUE</span>,
                         cov_mat <span class="op">=</span> <span class="va">cov_mat</span>,
                         covariate_names <span class="op">=</span> <span class="va">covariate_names</span>,
                         method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
                         lower <span class="op">=</span> <span class="va">bds</span>,
                         upper <span class="op">=</span> <span class="op">-</span><span class="va">bds</span>,
                         hessian <span class="op">=</span> <span class="cn">TRUE</span>
                         <span class="op">)</span>
    <span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">t1</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Optimization time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="va">t2</span> <span class="op">/</span> <span class="fl">60</span>, <span class="fl">3</span><span class="op">)</span>,
                <span class="st">"min"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">hessian</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">beta_mat</span><span class="op">[</span><span class="va">jj</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span>
    <span class="va">lower</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>
    <span class="va">upper</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span>
    <span class="va">cov_mat</span><span class="op">[</span><span class="va">jj</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">&gt;=</span> <span class="va">lower</span> <span class="op">&amp;</span>
                      <span class="va">best_params</span><span class="op">$</span><span class="va">par</span> <span class="op">&lt;=</span> <span class="va">upper</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>
 
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">-</span><span class="va">best_params</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">par</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">se_boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">beta_mat</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>beta_mat <span class="op">=</span> <span class="va">beta_mat</span>,
           se_boot <span class="op">=</span> <span class="va">se_boot</span><span class="op">)</span>, <span class="st">"naive-tab-boot.RDS"</span><span class="op">)</span></code></pre></div>
</div>
<div id="table-outputs-for-the-three-models-combined--analyze-data-big-table-r" class="section level4">
<h4 class="hasAnchor">
<a href="#table-outputs-for-the-three-models-combined--analyze-data-big-table-r" class="anchor"></a>Table outputs for the three models combined. <code>analyze-data-big-table.R</code>
</h4>
<p>Expected run-time: ~seconds, given outputs from above</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## SKG</span>
<span class="co">## August 14, 2020</span>
<span class="co">## Combining the tables together from three model types</span>
<span class="co">## Updated June 22, 2021</span>

<span class="va">rep_from_lib</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>

<span class="kw">if</span><span class="op">(</span><span class="va">rep_from_lib</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/skgallagher/InfectionTrees">InfectionTrees</a></span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span>



<span class="co">## loglike table BASE MODEL</span>
<span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">fn_rds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"RDS"</span>, <span class="va">files</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"base"</span>, <span class="va">fn_rds</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">data_list_base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="va">fn</span><span class="op">)</span>

<span class="va">loglike_df_base</span> <span class="op">&lt;-</span> <span class="va">data_list_base</span><span class="op">$</span><span class="va">loglike_df</span>

<span class="va">loglike_df_base</span><span class="op">$</span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Null"</span>,
                          <span class="st">"Smear"</span>,
                     <span class="st">"Smear/HIV"</span>,
                     <span class="st">"Smear/HIV/rel. time"</span>,
                     <span class="st">"Smear/HIV/rel. time/race"</span><span class="op">)</span>
<span class="va">loglike_df_base</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="st">"Base"</span>

<span class="co">############################################</span>
<span class="co">## OUTSIDER MODEL</span>

<span class="va">files_o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">fn_rds_o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"RDS"</span>, <span class="va">files_o</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">fn_rds2_o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"mot"</span>, <span class="va">fn_rds_o</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">data_list_o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="va">fn_rds2_o</span><span class="op">)</span>


<span class="va">loglike_df_o</span> <span class="op">&lt;-</span> <span class="va">data_list_o</span><span class="op">$</span><span class="va">loglike_df</span>

<span class="va">loglike_df_o</span><span class="op">$</span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Null"</span>,
                       <span class="st">"Smear"</span>,
                       <span class="st">"Smear/HIV"</span>,
                       <span class="st">"Smear/HIV/rel. time"</span>,
                       <span class="st">"Smear/HIV/rel. time/race"</span><span class="op">)</span>
<span class="va">loglike_df_o</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="st">"Multiple outside"</span>
<span class="co">#########################################################################</span>
<span class="co">## TABLE 5 - loglike for models</span>
<span class="co">#####################################################</span>
<span class="va">combined_loglike_df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">loglike_df_base</span>,
                                        <span class="va">loglike_df_o</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">type</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">combined_loglike_df</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">model</span>, <span class="va">vars</span>, <span class="va">n_params</span>, <span class="va">loglike</span>, <span class="va">aic</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>format <span class="op">=</span> <span class="st">"latex"</span>, digits <span class="op">=</span> <span class="fl">2</span>,
          caption <span class="op">=</span> <span class="st">"Reported log likelihood for the Maryland TB data for the five different models described in Eq. \\eqref{eq:data-models} for both the base and multiple outside transmissions model types."</span>,
          label <span class="op">=</span> <span class="st">"data-models"</span>,
          col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Type"</span>, <span class="st">"Model #"</span>, <span class="st">"Covariates"</span>, <span class="st">"# parameters"</span>, <span class="st">"Log like"</span>, <span class="st">"AIC"</span><span class="op">)</span>,
          booktabs <span class="op">=</span> <span class="cn">TRUE</span>,
          linesep <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>latex_options <span class="op">=</span> <span class="st">"striped"</span>, position <span class="op">=</span> <span class="st">"center"</span>,
                  stripe_index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/row_spec.html">row_spec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, background <span class="op">=</span> <span class="st">"yellow"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/row_spec.html">row_spec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span>, background <span class="op">=</span> <span class="st">"yellow"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/row_spec.html">row_spec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, extra_latex_after <span class="op">=</span> <span class="st">"\\midrule"</span><span class="op">)</span>


<span class="co">#########################################################</span>
<span class="co">###############################################################</span>
<span class="co">## TABLE 6 - best model coefficients</span>
<span class="co">## BEST MODELS</span>
<span class="co">## smear/HIV/rel time</span>


<span class="co">## BASE</span>
<span class="va">best_mod_base2</span> <span class="op">&lt;-</span> <span class="va">data_list_base</span><span class="op">$</span><span class="va">beta_list</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">]</span>
<span class="va">coeff_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="st">"Smear pos."</span>,
                 <span class="st">"HIV neg.: HIV pos."</span>,
                 <span class="st">"HIV unk.: HIV pos."</span>,
                 <span class="st">"Relative time"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">best_mod_base2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
<span class="va">best_mod_base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Type <span class="op">=</span> <span class="st">"Base"</span>,
                            Coeff <span class="op">=</span> <span class="va">coeff_names</span>,
                             <span class="va">best_mod_base2</span><span class="op">)</span>
<span class="co">## add boot strap SE</span>
<span class="va">base_boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"biowulf-results/bootstrap_sims_base_2021-06-23.RDS"</span><span class="op">)</span>
<span class="va">best_mod_base</span><span class="op">$</span><span class="va">se_boot</span> <span class="op">&lt;-</span> <span class="va">base_boot</span><span class="op">$</span><span class="va">se_vec</span>

<span class="co">## OUTSIDER</span>
<span class="va">best_mod_o2</span> <span class="op">&lt;-</span> <span class="va">data_list_o</span><span class="op">$</span><span class="va">beta_list</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span>
<span class="va">coeff_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="st">"Smear pos."</span>,
                 <span class="st">"HIV neg.: HIV pos."</span>,
                 <span class="st">"HIV unk.: HIV pos."</span>,
                 <span class="st">"Relative time"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">best_mod_o2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
<span class="va">best_mod_o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Type <span class="op">=</span> <span class="st">"Multiple outside"</span>,
                            Coeff <span class="op">=</span> <span class="va">coeff_names</span>,
                         <span class="va">best_mod_o2</span><span class="op">)</span>
<span class="co">## add boot strap SE</span>
<span class="va">mot_boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"biowulf-results/bootstrap_sims_mot_2021-06-24.RDS"</span><span class="op">)</span>
<span class="va">best_mod_o</span><span class="op">$</span><span class="va">se_boot</span> <span class="op">&lt;-</span> <span class="va">mot_boot</span><span class="op">$</span><span class="va">se_vec</span>


<span class="co">## NAIVE MODEL</span>
<span class="va">best_mod_naive2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"naive-tab.RDS"</span><span class="op">)</span><span class="op">)</span>
<span class="va">coeff_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="st">"Smear pos."</span>,
                 <span class="st">"HIV neg.: HIV pos."</span>,
                 <span class="st">"HIV unk.: HIV pos."</span>,
                 <span class="st">"Relative time"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">best_mod_naive2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
<span class="va">best_mod_naive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Type <span class="op">=</span> <span class="st">"Naive"</span>,
                            Coeff <span class="op">=</span> <span class="va">coeff_names</span>,
                            <span class="va">best_mod_naive2</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"Est."</span> <span class="op">=</span> <span class="va">Mean</span><span class="op">)</span>
<span class="co">## Se boot</span>
<span class="va">naive_boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"naive-tab-boot.RDS"</span><span class="op">)</span>
<span class="va">best_mod_naive</span><span class="op">$</span><span class="va">se_boot</span> <span class="op">&lt;-</span> <span class="va">naive_boot</span><span class="op">$</span><span class="va">se_boot</span>

<span class="co">########</span>
<span class="co">## Putting it all together</span>
<span class="va">combined_best_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">best_mod_base</span>,
                           <span class="va">best_mod_o</span>,
                           <span class="va">best_mod_naive</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>or <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">`Est.`</span><span class="op">)</span>,
           lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">`Est.`</span><span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se_boot</span><span class="op">)</span>,
           upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">`Est.`</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se_boot</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pretty_or <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.2f [%.2f, %.2f]"</span>, <span class="va">or</span>, <span class="va">lower</span>, <span class="va">upper</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>combined_se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"(%.2f, %.2f)"</span>, <span class="va">SE</span>, <span class="va">se_boot</span><span class="op">)</span><span class="op">)</span>









<span class="va">combined_best_mod</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Type"</span>, <span class="st">"Coeff"</span>, <span class="st">"Est."</span>, <span class="st">"combined_se"</span>, <span class="st">"pretty_or"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>format <span class="op">=</span> <span class="st">"latex"</span>, booktabs <span class="op">=</span> <span class="cn">TRUE</span>,
          col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Type"</span>, <span class="st">"Coeff."</span>,
                        <span class="st">"$\\hat{\\beta}$"</span>,  <span class="st">"$\\widehat{SE}_F(\\hat{\\beta}), \\widehat{SE}_B(\\hat{\\beta})$"</span>,
                        <span class="st">"Odds Ratio [95\\% CI]"</span><span class="op">)</span>,
          caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Coefficient estimates for the best selected model."</span>,
                          <span class="st">"We report the mean estimate and two estimates of the standard error of the $\\beta$ values"</span>,
                          <span class="st">"in addition to the odds ratio and 95\\% CI.  $SE_F$ represents standard error"</span>,
                          <span class="st">"derived from the Fisher information, and $SE_B$ represents the bootstrap standard error."</span>,
                          <span class="st">"The 95\\% CI is estimated using the bootstrap SE."</span><span class="op">)</span>,
          label <span class="op">=</span> <span class="st">"best-model-ests"</span>,
          digits <span class="op">=</span> <span class="fl">2</span>,
          linesep <span class="op">=</span> <span class="st">""</span>,
          escape <span class="op">=</span> <span class="cn">FALSE</span>,
          align <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"l"</span>, <span class="st">"c"</span>, <span class="st">"c"</span>, <span class="st">"c"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>latex_options <span class="op">=</span> <span class="st">"striped"</span>, position <span class="op">=</span> <span class="st">"center"</span>,
                  stripe_index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">7</span>,  <span class="fl">11</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/row_spec.html">row_spec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">9</span>,<span class="fl">10</span>, <span class="fl">13</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span>, background <span class="op">=</span> <span class="st">"yellow"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/row_spec.html">row_spec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>, extra_latex_after <span class="op">=</span> <span class="st">"\\midrule"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="figure-4-most-likely-trees-for-the-base-model--fig4-most-likely-trees-r" class="section level3">
<h3 class="hasAnchor">
<a href="#figure-4-most-likely-trees-for-the-base-model--fig4-most-likely-trees-r" class="anchor"></a>Figure 4, most likely trees for the base model. <code>fig4-most-likely-trees.R</code>
</h3>
<p>Expected run-time: ~seconds, given outputs from above</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## SKG</span>
<span class="co">## June 22, 2021</span>
<span class="co">## JCGS revision to reproduce code for most likely trees</span>


<span class="co">#################################################</span>
<span class="co">## A couple helper functions</span>

<span class="co">#' Assign x-coordinates based on generation and index for a single cluster</span>
<span class="co">#'</span>
<span class="co">#' @param gen generation number</span>
<span class="co">#' @return generation number</span>
<span class="va">assign_coords_x</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">gen</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">gen</span><span class="op">)</span>
<span class="op">}</span>


<span class="co">#' Assign x-coordinates based on generation and index for a single cluster</span>
<span class="co">#'</span>
<span class="co">#' @param index index ONLY for those in a single generation</span>
<span class="co">#' @param ymin default is -1</span>
<span class="co">#' @param ymax default is 1</span>
<span class="co">#' @return index space, evenly spaced by number in generation</span>
<span class="va">assign_coords_y</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span>,
                            <span class="va">ymin</span> <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, <span class="va">ymax</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span>
    <span class="va">gen_ranks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/frank.html">rank</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span>
    <span class="va">n_in_gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">gen_ranks</span><span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span><span class="va">n_in_gen</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="va">y</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="va">gen_ranks</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span><span class="op">(</span><span class="fl">.5</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">gen_ranks</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>

<span class="op">}</span>

<span class="co">###########################################################</span>


<span class="va">rep_from_lib</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>

<span class="kw">if</span><span class="op">(</span><span class="va">rep_from_lib</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/skgallagher/InfectionTrees">InfectionTrees</a></span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span>


<span class="co">## Subset data to cluster 27, it's cool</span>
<span class="va">tb_ex</span> <span class="op">&lt;-</span> <span class="va">tb_clean</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">group</span> <span class="op">==</span> <span class="fl">27</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rel_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">rel_time</span><span class="op">)</span> <span class="op">/</span> <span class="fl">365</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">rel_time</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>order <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>smear <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">spsmear</span> <span class="op">==</span> <span class="st">"Positive"</span>,
                                 <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
                  cluster_id <span class="op">=</span> <span class="va">group</span>,
                  hiv_f <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hivstatus</span> <span class="op">==</span> <span class="st">"Negative"</span>, <span class="st">"neg"</span>,
                          <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hivstatus</span> <span class="op">==</span> <span class="st">"Positive"</span>, <span class="st">"pos"</span>,
                                 <span class="st">"unk"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hiv_neg_pos <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hiv_f</span> <span class="op">==</span> <span class="st">"neg"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
                  hiv_unk_pos <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">hiv_f</span> <span class="op">==</span> <span class="st">"unk"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## Load in best results from base model</span>
<span class="va">fns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">fns_rds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">".RDS"</span>, <span class="va">fns</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">base_model_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"base"</span>, <span class="va">fns_rds</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="va">inf_params</span> <span class="op">&lt;-</span> <span class="va">base_model_results</span><span class="op">$</span><span class="va">beta_list</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>

<span class="co">## Sample a bunch of MC trees</span>
<span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">100000</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">622021</span><span class="op">)</span>
<span class="va">covariate_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"smear"</span>,
                         <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>,
                         <span class="st">"rel_time"</span><span class="op">)</span>
<span class="va">mc_trees</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/sample_mc_trees.html">sample_mc_trees</a></span><span class="op">(</span><span class="va">tb_ex</span>,
                            B <span class="op">=</span> <span class="va">B</span>,
                            multiple_outside_transmissions <span class="op">=</span> <span class="cn">FALSE</span>,
                            covariate_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">covariate_names</span>,
                                                <span class="st">"order"</span><span class="op">)</span><span class="op">)</span>
<span class="co">## get the covariate matrix</span>
<span class="va">cov_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/covariate_df_to_mat.html">covariate_df_to_mat</a></span><span class="op">(</span><span class="va">mc_trees</span>,
                                cov_names <span class="op">=</span> <span class="va">covariate_names</span><span class="op">)</span>
<span class="va">mc_trees</span><span class="op">$</span><span class="va">prob_inf</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">cov_mat</span> <span class="op">%*%</span> <span class="va">inf_params</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">cluster_id</span> <span class="op">&lt;-</span> <span class="va">n_inf</span> <span class="op">&lt;-</span> <span class="va">orig_id</span> <span class="op">&lt;-</span> <span class="va">prob_inf</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
<span class="va">my_prob_inf</span> <span class="op">&lt;-</span>  <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">cov_mat</span> <span class="op">%*%</span> <span class="va">inf_params</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Turning mc_trees to a data table</span>
<span class="va">mc_trees.dt</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">mc_trees</span><span class="op">)</span>
<span class="va">mc_trees.dt</span> <span class="op">&lt;-</span> <span class="va">mc_trees.dt</span><span class="op">[</span>, <span class="va">prob_inf</span> <span class="op">:=</span> <span class="va">my_prob_inf</span><span class="op">]</span>
<span class="va">cluster_id</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>

<span class="co">## Getting the likelihood for each sampled cluster</span>
<span class="va">like_df</span> <span class="op">&lt;-</span> <span class="va">mc_trees.dt</span><span class="op">[</span>,
                    <span class="fu">.</span><span class="op">(</span>like <span class="op">=</span> <span class="fu"><a href="../../reference/general_cluster_like.dt.html">general_cluster_like.dt</a></span><span class="op">(</span><span class="va">prob_inf</span>, <span class="va">n_inf</span><span class="op">)</span><span class="op">)</span>,
                    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">orig_id</span>, <span class="va">cluster_id</span><span class="op">)</span><span class="op">]</span>

<span class="va">mc_trees_like</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">mc_trees</span>, <span class="va">like_df</span>,
                           by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">orig_id</span>, <span class="va">cluster_id</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="va">like</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">like</span><span class="op">)</span><span class="op">)</span>



<span class="va">df</span> <span class="op">&lt;-</span> <span class="va">mc_trees_like</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">assign_coords_x</span><span class="op">(</span><span class="va">gen</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster_id</span>, <span class="va">gen</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu">assign_coords_y</span><span class="op">(</span><span class="va">n_in_gen</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>gen_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">gen</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span><span class="op">)</span>

<span class="va">top_groups_by_gen</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">gen_size</span>, <span class="va">cluster_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span>,
              .groups <span class="op">=</span> <span class="st">"drop_last"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op">(</span>order_by <span class="op">=</span> <span class="va">prob</span>, n <span class="op">=</span> <span class="fl">3</span>, with_ties <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="va">top_clusts</span> <span class="op">&lt;-</span> <span class="va">top_groups_by_gen</span><span class="op">$</span><span class="va">cluster_id</span>


<span class="va">df_sub</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cluster_id</span> <span class="op">%in%</span> <span class="va">top_clusts</span><span class="op">)</span>
<span class="va">df_sub</span> <span class="op">&lt;-</span>  <span class="va">df_sub</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>facet <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">gen_size</span>, <span class="va">cluster_id</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span><span class="op">)</span>


<span class="va">inf_df</span> <span class="op">&lt;-</span> <span class="va">df_sub</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">cluster_id</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>x_to <span class="op">=</span> <span class="va">x</span>, y_to <span class="op">=</span> <span class="va">y</span>,
           inf_id <span class="op">=</span> <span class="va">id</span><span class="op">)</span>

<span class="va">jsub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df_sub</span>, <span class="va">inf_df</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cluster_id"</span>,  <span class="st">"inf_id"</span><span class="op">)</span><span class="op">)</span>
<span class="va">fctr_sub</span> <span class="op">&lt;-</span> <span class="va">df_sub</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>like <span class="op">=</span> <span class="va">prob</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
<span class="va">jsub</span><span class="op">$</span><span class="va">factor_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">jsub</span><span class="op">$</span><span class="va">cluster_id</span>,
                         labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Sample "</span>,
                                         <span class="va">fctr_sub</span><span class="op">$</span><span class="va">cluster_id</span>,
                                         <span class="st">": P(C) = "</span>,
                                         <span class="fu"><a href="https://rdrr.io/r/base/formatc.html">formatC</a></span><span class="op">(</span><span class="va">fctr_sub</span><span class="op">$</span><span class="va">like</span>,
                                                 format <span class="op">=</span> <span class="st">"e"</span>,
                                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">jsub</span><span class="op">$</span><span class="va">factor_gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">jsub</span><span class="op">$</span><span class="va">gen_size</span>,
                          levels <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">jsub</span><span class="op">$</span><span class="va">gen_size</span><span class="op">)</span>,
                          labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Gen. "</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">jsub</span><span class="op">$</span><span class="va">gen_size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>



<span class="va">fctr_sub2</span> <span class="op">&lt;-</span> <span class="va">df_sub</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">facet</span>, <span class="va">gen_size</span>, <span class="va">cluster_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>like <span class="op">=</span> <span class="va">prob</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span>
              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">cluster_id</span>, start <span class="op">=</span> <span class="op">-</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">jsub</span><span class="op">$</span><span class="va">facet_lab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">jsub</span><span class="op">$</span><span class="va">facet</span>,
                         levels <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">fctr_sub2</span><span class="op">$</span><span class="va">facet</span><span class="op">)</span>,
                         labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"# Gens: "</span>,
                                         <span class="va">fctr_sub2</span><span class="op">$</span><span class="va">gen_size</span>,
                                         <span class="st">"; ID: "</span>,
                                         <span class="va">fctr_sub2</span><span class="op">$</span><span class="va">id</span>,
                                         <span class="st">"; P(C) = "</span>,
                                         <span class="fu"><a href="https://rdrr.io/r/base/formatc.html">formatC</a></span><span class="op">(</span><span class="va">fctr_sub2</span><span class="op">$</span><span class="va">like</span>,
                                                 format <span class="op">=</span> <span class="st">"e"</span>,
                                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">my_orig_id</span> <span class="op">&lt;-</span> <span class="fl">27</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">jsub</span>,
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>,
           group <span class="op">=</span> <span class="va">cluster_id</span>,
           col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">order</span><span class="op">)</span>,
            shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">hiv_neg_pos</span><span class="op">)</span>
           <span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_curve</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xend <span class="op">=</span> <span class="va">x_to</span>, yend <span class="op">=</span> <span class="va">y_to</span><span class="op">)</span>,
               size <span class="op">=</span> <span class="fl">2</span>, curvature <span class="op">=</span> <span class="op">-</span><span class="fl">0</span>,
               col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">6</span>, stroke <span class="op">=</span> <span class="fl">4</span>, col <span class="op">=</span> <span class="st">"darkgray"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, stroke <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">facet_lab</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span>, name <span class="op">=</span> <span class="st">"Detection Order"</span><span class="op">)</span>  <span class="op">+</span>
     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_shape_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">16</span><span class="op">)</span>,
                    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Pos./Unk."</span>, <span class="st">"Neg."</span><span class="op">)</span>,
                   name <span class="op">=</span> <span class="st">"HIV Status"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span><span class="op">(</span><span class="fl">.8</span>, <span class="fl">7.2</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.2</span>, <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
          axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
          axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Generation in transmission tree"</span>,
         y <span class="op">=</span> <span class="fu">latex2exp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/latex2exp/man/TeX.html">TeX</a></span><span class="op">(</span><span class="st">"Order of infection in gen. among 'siblings' $\\rightarrow$"</span><span class="op">)</span>,
         title <span class="op">=</span> <span class="st">"Most likely sampled trees by number of generations"</span>,
         subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Cluster "</span>, <span class="va">my_orig_id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, legend.box <span class="op">=</span> <span class="st">"horizontal"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>


<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="st">"trees-7.pdf"</span>, height <span class="op">=</span> <span class="fl">15</span>, width <span class="op">=</span> <span class="fl">13</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="algorithm-to-compute-whether-we-have-enough-samples-enough-mc-treessampling-enough-mc-trees-r" class="section level2">
<h2 class="hasAnchor">
<a href="#algorithm-to-compute-whether-we-have-enough-samples-enough-mc-treessampling-enough-mc-trees-r" class="anchor"></a>Algorithm to compute whether we have enough samples <code>enough-MC-trees/sampling-enough-mc-trees.R</code>
</h2>
<p>Expected run-time: ~2 days</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## ----setup, include=FALSE--------------------------------------------------------------------------------------</span>

<span class="va">rep_from_lib</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>

<span class="kw">if</span><span class="op">(</span><span class="va">rep_from_lib</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/skgallagher/InfectionTrees">InfectionTrees</a></span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>


<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/skgallagher/InfectionTrees">InfectionTrees</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>


<span class="co">## --------------------------------------------------------------------------------------------------------------</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2020</span><span class="op">)</span>
<span class="co">## Generate possible covariates</span>
<span class="va">sample_covariates_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span>

<span class="va">beta0</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">2.5</span>
<span class="va">beta1</span> <span class="op">&lt;-</span> <span class="fl">.5</span>
<span class="va">M</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/simulate_bp.html">simulate_bp</a></span><span class="op">(</span>K <span class="op">=</span> <span class="va">M</span>,
                                  inf_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">beta0</span>, <span class="va">beta1</span><span class="op">)</span>,
                                  sample_covariates_df <span class="op">=</span> <span class="va">sample_covariates_df</span>,
                                  covariate_names <span class="op">=</span> <span class="st">"x"</span>,
                                  max_size <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>

 <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>cluster_size <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster_size</span><span class="op">)</span> <span class="op">%&gt;%</span>
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>freq <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"html"</span><span class="op">)</span> <span class="op">%&gt;%</span>
   <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>bootstrap_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span><span class="op">)</span>, full_width <span class="op">=</span> <span class="cn">F</span>,
                 position <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>




<span class="co">## --------------------------------------------------------------------------------------------------------------</span>
<span class="co">## Summarize data set into a table</span>
<span class="va">binary_cluster_summaries</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/summarize_binary_clusters.html">summarize_binary_clusters</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>

<span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">5</span>  <span class="co">## Should change to 30+</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">5000</span>

<span class="va">beta_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">B</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">var_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">B</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">seed</span> <span class="op">&lt;-</span> <span class="fl">9152020</span>

<span class="kw">for</span><span class="op">(</span><span class="va">bb</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">B</span><span class="op">)</span><span class="op">{</span>

    <span class="co">## Get different seeds for MC sets</span>
  <span class="va">seed</span> <span class="op">&lt;-</span> <span class="va">seed</span> <span class="op">+</span> <span class="va">bb</span> <span class="op">*</span> <span class="fl">10</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span>

  <span class="co">## Sample MC trees</span>
  <span class="va">mc_trees</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/sample_mc_binary_cov.html">sample_mc_binary_cov</a></span><span class="op">(</span><span class="va">K</span>,
                                 observed_cluster_summaries <span class="op">=</span> <span class="va">binary_cluster_summaries</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">freq</span><span class="op">)</span>

  <span class="co">## Fit model</span>
  <span class="va">inf_params_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>
  <span class="va">best_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="va">inf_params_0</span>, fn <span class="op">=</span> <span class="va">bp_loglike_binary_cov</span>,
                       obs_data_summary <span class="op">=</span> <span class="va">binary_cluster_summaries</span>,
                       mc_samples_summary <span class="op">=</span> <span class="va">mc_trees</span>,
                       return_neg <span class="op">=</span> <span class="cn">TRUE</span>,
                       lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="op">-</span><span class="fl">5</span><span class="op">)</span>,
                       upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>,
                       method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
                       hessian <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>



  <span class="va">beta_mat</span><span class="op">[</span><span class="va">bb</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">best_params</span><span class="op">$</span><span class="va">par</span>
  <span class="va">var_mat</span><span class="op">[</span><span class="va">bb</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">$</span><span class="va">hessian</span><span class="op">)</span><span class="op">)</span>  <span class="co">## Var from obs. fisher info</span>


<span class="op">}</span>



<span class="co">## --------------------------------------------------------------------------------------------------------------</span>

<span class="va">wald_scores_fisher</span> <span class="op">&lt;-</span> <span class="va">beta_mat</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">var_mat</span><span class="op">)</span>
<span class="va">wald_se_fisher</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">wald_scores_fisher</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>
<span class="va">se_mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">beta_mat</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>
<span class="va">wald_scores_mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">beta_mat</span><span class="op">)</span> <span class="op">/</span> <span class="va">se_mc</span><span class="op">)</span>
<span class="va">wald_se_mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">wald_scores_mc</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>




<span class="va">wald_se_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbind</a></span><span class="op">(</span><span class="va">wald_se_fisher</span>, <span class="va">wald_se_mc</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">wald_se_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Fisher"</span>, <span class="st">"MC"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">wald_se_mat</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>bootstrap_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Shannon Gallagher, Dean Follmann.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
