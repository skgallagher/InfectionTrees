<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TB Data Results: base model but with positive imputation • InfectionTrees</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="TB Data Results: base model but with positive imputation">
<meta property="og:description" content="InfectionTrees">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">InfectionTrees</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/getting-started.html">Getting started with `InfectionTrees`</a>
    </li>
    <li class="divider">
    <li>
      <a href="../../articles/index.html">More...</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/skgallagher/InfectionTrees/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="tb-data-base-pos-imputation_files/header-attrs-2.3/header-attrs.js"></script><script src="tb-data-base-pos-imputation_files/kePrint-0.0.1/kePrint.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>TB Data Results: base model but with positive imputation</h1>
            
            <h4 class="date">2020-10-07</h4>

      <small class="dont-index">Source: <a href="https://github.com/skgallagher/InfectionTrees/blob/master/vignettes/not-built-vignettes/tb-data-base-pos-imputation.Rmd"><code>vignettes/not-built-vignettes/tb-data-base-pos-imputation.Rmd</code></a></small>
      <div class="hidden name"><code>tb-data-base-pos-imputation.Rmd</code></div>

    </div>

    
    
<div id="libraries" class="section level2">
<h2 class="hasAnchor">
<a href="#libraries" class="anchor"></a>Libraries</h2>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">InfectionTrees</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">kableExtra</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">forcats</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">readr</span>)</pre></body></html></div>
</div>
<div id="vignette-goals" class="section level2">
<h2 class="hasAnchor">
<a href="#vignette-goals" class="anchor"></a>Vignette goals</h2>
<p>In this vignette, we repeat the prior analysis but impute the smear covariates to be positive instead.</p>
<ol style="list-style-type: decimal">
<li><p>Briefly recap the data used in the analysis</p></li>
<li><p>Fit a series of nested models to the data using our base model</p></li>
<li><p>Repeat the model fitting with the Multiple Outside Transmission model</p></li>
<li><p>Examine standard errors</p></li>
</ol>
</div>
<div id="the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#the-data" class="anchor"></a>The Data</h2>
<p>The data can be accessed using <code><a href="https://rdrr.io/r/utils/data.html">data(tb_clean)</a></code>. The clusters are uniquely ID’d with the variable <code>group</code></p>
<p>The data consists of 159 clusters where each cluster contains between 1 and 25 individuals. These individuals have covariates corresponding to their smear status (+/-/NA), HIV status (+/-/unknown), date of sputum collection, and race (Asian/Black/White). Please see <code><a href="../../reference/tb_clean.html">?tb_clean</a></code> for more information.</p>
<p>There are only individuals who have smear status NA, and in this analysis we impute those to be smear -. We transform date of sputum collection into a variable we call relative time, which is the time in years between the reference sputum collection date and the first observed sputum within a cluster. Therefore, all relative time values of singleton clusters will have the value 0.</p>
<p>We consider HIV status and race to be categorical variables and use “HIV+” and “White” as the reference groups, respectively.</p>
<p>We use the below code to format <code>tb_clean</code> to use in our model fitting.</p>

<div class="sourceCode" id="cb2"><html><body><pre class="r"> <span class="no">clusters</span> <span class="kw">&lt;-</span> <span class="no">tb_clean</span> <span class="kw">%&gt;%</span>
        <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">smear</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">spsmear</span> <span class="kw">==</span> <span class="st">"Positive"</span>,
                                     <span class="fl">1</span>, <span class="fl">0</span>),
                      <span class="kw">cluster_id</span> <span class="kw">=</span> <span class="no">group</span>,
                      <span class="kw">hiv_f</span> <span class="kw">=</span> <span class="no">hivstatus</span>) <span class="kw">%&gt;%</span>
        <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">hiv_neg_pos</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">hiv_f</span> <span class="kw">==</span> <span class="st">"neg"</span>, <span class="fl">1</span>, <span class="fl">0</span>),
               <span class="kw">hiv_unk_pos</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">hiv_f</span> <span class="kw">==</span> <span class="st">"unk"</span>, <span class="fl">1</span>, <span class="fl">0</span>)) <span class="kw">%&gt;%</span>
        <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">cluster_id</span>) <span class="kw">%&gt;%</span>
        <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">rel_time</span> <span class="kw">=</span> <span class="no">rel_time</span> / <span class="fl">365</span>) <span class="kw">%&gt;%</span>
        <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">cluster_size</span> <span class="kw">=</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span>()) <span class="kw">%&gt;%</span>
        <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">smear</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">spsmear</span> <span class="kw">==</span> <span class="st">"Negative"</span>,
                          <span class="fl">0</span>, <span class="fl">1</span>),
           <span class="kw">cluster_id</span> <span class="kw">=</span> <span class="no">group</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">hiv_neg_pos</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">hiv_f</span> <span class="kw">==</span> <span class="st">"neg"</span>, <span class="fl">1</span>, <span class="fl">0</span>),
           <span class="kw">hiv_unk_pos</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">hiv_f</span> <span class="kw">==</span> <span class="st">"unk"</span>, <span class="fl">1</span>, <span class="fl">0</span>)) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">cluster_id</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">cluster_size</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span>()) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">race_f</span> <span class="kw">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_collapse.html">fct_collapse</a></span>(<span class="no">race</span>,
                                 <span class="kw">white</span> <span class="kw">=</span> <span class="st">"White"</span>,
                                 <span class="kw">black</span> <span class="kw">=</span> <span class="st">"Black or African American"</span>,
                                 <span class="kw">asian</span> <span class="kw">=</span> <span class="st">"Asian"</span>)) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">race_asian_white</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">race_f</span> <span class="kw">==</span> <span class="st">"asian"</span>, <span class="fl">1</span>, <span class="fl">0</span>),
           <span class="kw">race_black_white</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">race_f</span> <span class="kw">==</span> <span class="st">"black"</span>, <span class="fl">1</span>, <span class="fl">0</span>)) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">cluster_id</span>, <span class="no">smear</span>,
           <span class="no">hiv_neg_pos</span>,
           <span class="no">hiv_unk_pos</span>,
           <span class="no">rel_time</span>,
           <span class="no">race_asian_white</span>,
           <span class="no">race_black_white</span>,
           <span class="no">cluster_size</span>)</pre></body></html></div>
</div>
<div id="model-fitting" class="section level2 tabset">
<h2 class="hasAnchor">
<a href="#model-fitting" class="anchor"></a>Model fitting</h2>
<p>We analyze the series of nested models:</p>
<p>Model 1: <span class="math inline">\(logit(p_i) = \beta_0\)</span></p>
<p>Model 2: <span class="math inline">\(logit(p_i) = \beta_0 + \beta_{1}x_{i,{smear pos}}\)</span></p>
<p>Model 3: <span class="math inline">\(logit(p_i) = \beta_0 + \beta_{1}x_{i,smear pos} + \beta_{2}x_{i,{HIV neg}}+ \beta_{3}x_{i,{HIV unk}}\)</span></p>
<p>Model 4: <span class="math inline">\(logit(p_i) = \beta_0 + \beta_{1}x_{i,{smear pos}} + \beta_{2}x_{i,{HIV neg}} + \beta_{3}x_{i,{HIV unk}} + \beta_{4}x_{i,{rel. time}}\)</span></p>
<p>Model 5: <span class="math inline">\(logit(p_i) = \beta_0 + \beta_{1}x_{i,{smear pos}} + \beta_{2}x_{i,{HIV neg}} + \beta_{3}x_{i,{HIV unk}} + \beta_{4}x_{i,{rel. time}} + \beta_{5}x_{i,{race Asian}} + \beta_{6}x_{i,{race Black}}\)</span></p>
<div id="the-base-model" class="section level3">
<h3 class="hasAnchor">
<a href="#the-base-model" class="anchor"></a>The base model</h3>
<p>We first fit our base model described in <a href="model-overview.html">the model overview</a>, where we assume that the infections within a cluster can be traced back to a root individual within the cluster.</p>
<p>We use the below code to fit each of the models where we use <span class="math inline">\(K=1000\)</span> MC samples for each cluster in the data. We then report the log likelihood and AIC for each of the models.</p>
<p><strong>Note</strong> that for the full results, we use <span class="math inline">\(K=10000\)</span>, which takes about ~3 hour to run on a PC.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">K</span> <span class="kw">&lt;-</span> <span class="fl">1000</span>
<span class="no">my_seed</span> <span class="kw">&lt;-</span> <span class="fl">42</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="no">my_seed</span>)

<span class="co">## MODELS</span>
<span class="co">## models</span>
<span class="no">covariate_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="kw">mode</span> <span class="kw">=</span> <span class="st">"list"</span>, <span class="kw">length</span> <span class="kw">=</span> <span class="fl">5</span>)
<span class="no">covariate_list</span><span class="kw">[[</span><span class="fl">1</span>]] <span class="kw">&lt;-</span> <span class="fl">NA</span>
<span class="no">covariate_list</span><span class="kw">[[</span><span class="fl">2</span>]] <span class="kw">&lt;-</span> <span class="st">"smear"</span>
<span class="no">covariate_list</span><span class="kw">[[</span><span class="fl">3</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"smear"</span>,
                         <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>)
<span class="no">covariate_list</span><span class="kw">[[</span><span class="fl">4</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"smear"</span>,
                         <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>,
                         <span class="st">"rel_time"</span>)
<span class="no">covariate_list</span><span class="kw">[[</span><span class="fl">5</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"smear"</span>,
                         <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>,
                         <span class="st">"rel_time"</span>,
                         <span class="st">"race_asian_white"</span>,
                         <span class="st">"race_black_white"</span>)

<span class="co">## Set up outputs</span>
<span class="no">loglike_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">model</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_list</span>),
                         <span class="kw">n_params</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">7</span>),
                         <span class="kw">loglike</span> <span class="kw">=</span> <span class="fl">0</span>,
                         <span class="kw">aic</span> <span class="kw">=</span> <span class="fl">0</span>)
<span class="no">beta_mat1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">4</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">beta_mat1</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Intercept"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">beta_mat1</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Est."</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>, <span class="st">"SE"</span>)
<span class="no">beta_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="kw">mode</span> <span class="kw">=</span> <span class="st">"list"</span>, <span class="kw">length</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_list</span>))
<span class="no">beta_list</span><span class="kw">[[</span><span class="fl">1</span>]] <span class="kw">&lt;-</span> <span class="no">beta_mat1</span>
<span class="kw">for</span>(<span class="no">ii</span> <span class="kw">in</span> <span class="fl">2</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_list</span>)){
  <span class="no">mat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_list</span><span class="kw">[[</span><span class="no">ii</span>]]) + <span class="fl">1</span>,
                <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">4</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">mat</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Intercept"</span>, <span class="no">covariate_list</span><span class="kw">[[</span><span class="no">ii</span>]])
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">mat</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Est."</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>, <span class="st">"SE"</span>)
  <span class="no">beta_list</span><span class="kw">[[</span><span class="no">ii</span>]] <span class="kw">&lt;-</span> <span class="no">mat</span>
}</pre></body></html></div>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">t_init</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()[<span class="fl">3</span>]

<span class="co">## Sample MC trees all at once</span>

    <span class="no">t0</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()[<span class="fl">3</span>]
    <span class="co">## Sample all MC clusters at once for each of the 5 models</span>
    <span class="no">mc_trees</span> <span class="kw">&lt;-</span>  <span class="fu"><a href="../../reference/sample_mc_trees.html">sample_mc_trees</a></span>(<span class="no">clusters</span>,
                                 <span class="kw">B</span> <span class="kw">=</span> <span class="no">K</span>,
                                 <span class="kw">multiple_outside_transmissions</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                                 <span class="kw">covariate_names</span> <span class="kw">=</span> <span class="no">covariate_list</span><span class="kw">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_list</span>)]])
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()[<span class="fl">3</span>] - <span class="no">t0</span>)


<span class="co">## Fit each of the models</span>

<span class="kw">for</span>(<span class="no">jj</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_list</span>)){
        <span class="no">covariate_names</span> <span class="kw">&lt;-</span> <span class="no">covariate_list</span><span class="kw">[[</span><span class="no">jj</span>]]
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Model:"</span>)
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">covariate_names</span>)
        <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">covariate_names</span>[<span class="fl">1</span>])){
            <span class="no">init_params</span> <span class="kw">&lt;-</span> <span class="fl">0</span>
        } <span class="kw">else</span>{
            <span class="no">init_params</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_names</span>) + <span class="fl">1</span>)
        }
        <span class="co">## Optimize</span>

        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Optimizing"</span>)
        <span class="no">bds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(-<span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">init_params</span>))
        <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_names</span>) <span class="kw">&gt;</span> <span class="fl">5</span>){
            <span class="no">bds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(-<span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">init_params</span>))
        }
        <span class="no">lower_bds</span> <span class="kw">&lt;-</span> <span class="no">bds</span>
        <span class="no">upper_bds</span> <span class="kw">&lt;-</span> -<span class="no">bds</span>
        <span class="no">cov_mat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/covariate_df_to_mat.html">covariate_df_to_mat</a></span>(<span class="no">mc_trees</span>,
                                       <span class="kw">cov_names</span> <span class="kw">=</span> <span class="no">covariate_names</span>)

    <span class="no">t1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()[<span class="fl">3</span>]
    <span class="no">best_params</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span>(<span class="kw">par</span> <span class="kw">=</span> <span class="no">init_params</span>,
                         <span class="kw">fn</span> <span class="kw">=</span> <span class="no">general_loglike</span>,
                         <span class="kw">mc_trees</span> <span class="kw">=</span> <span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span>(<span class="no">mc_trees</span>),
                         <span class="kw">return_neg</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                         <span class="kw">cov_mat</span> <span class="kw">=</span> <span class="no">cov_mat</span>,
                         <span class="kw">cov_names</span> <span class="kw">=</span> <span class="no">covariate_names</span>,
                         <span class="kw">use_outsider_prob</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                         <span class="kw">multiple_outside_transmissions</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                         <span class="kw">method</span> <span class="kw">=</span> <span class="st">"L-BFGS-B"</span>,
                         <span class="kw">lower</span> <span class="kw">=</span> <span class="no">lower_bds</span>,
                         <span class="kw">upper</span> <span class="kw">=</span> <span class="no">upper_bds</span>,
                         <span class="kw">hessian</span> <span class="kw">=</span> <span class="fl">TRUE</span>
                         )
    <span class="no">t2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()[<span class="fl">3</span>] - <span class="no">t1</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Optimization time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>( <span class="no">t2</span> / <span class="fl">60</span>, <span class="fl">3</span>),
                <span class="st">"min"</span>))

    <span class="no">beta_list</span><span class="kw">[[</span><span class="no">jj</span>]][, <span class="fl">4</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span>(<span class="no">best_params</span>$<span class="no">hessian</span>))) <span class="co">## SE from Fisher info</span>

    <span class="co">## Likelihood Profile ests</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Likelihood profiling"</span>)
    <span class="no">lp_ests</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/likelihood_profs.html">likelihood_profs</a></span>(<span class="kw">best_pars</span> <span class="kw">=</span> <span class="no">best_params</span>$<span class="no">par</span>,
                                    <span class="kw">max_loglike</span> <span class="kw">=</span> -<span class="no">best_params</span>$<span class="no">value</span>,
                                    <span class="kw">mc_trees</span> <span class="kw">=</span> <span class="no">mc_trees</span>,
                                    <span class="kw">covariate_names</span> <span class="kw">=</span> <span class="no">covariate_names</span>,
                                    <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">.05</span>,
                                    <span class="kw">multiple_outside_transmissions</span> <span class="kw">=</span> <span class="fl">FALSE</span>)

    <span class="no">beta_list</span><span class="kw">[[</span><span class="no">jj</span>]][,-<span class="fl">4</span>] <span class="kw">&lt;-</span> <span class="no">lp_ests</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"best params:"</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">beta_list</span><span class="kw">[[</span><span class="no">jj</span>]])
    <span class="no">loglike_df</span>$<span class="no">loglike</span>[<span class="no">jj</span>] <span class="kw">&lt;-</span> -<span class="no">best_params</span>$<span class="no">val</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Total time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>( (<span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()[<span class="fl">3</span>] - <span class="no">t_init</span>)  / <span class="fl">3600</span>, <span class="fl">3</span>),
                <span class="st">"hrs"</span>))


}</pre></body></html></div>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">loglike_df</span> <span class="kw">&lt;-</span> <span class="no">loglike_df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">aic</span> <span class="kw">=</span> -<span class="no">loglike</span> + <span class="fl">2</span> * <span class="no">n_params</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">5</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">model</span>, <span class="fu"><a href="https://tidyr.tidyverse.org/reference/reexports.html">everything</a></span>())


<span class="no">loglike_df</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/reexports.html">kable</a></span>(<span class="kw">digits</span> <span class="kw">=</span> <span class="fl">2</span>,
                     <span class="kw">col.names</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Model"</span>, <span class="st">"# params."</span>, <span class="st">"Log like."</span>, <span class="st">"AIC"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span>(<span class="kw">bootstrap_options</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"condensed"</span>, <span class="st">"hover"</span>, <span class="st">"striped"</span>, <span class="st">"responsive"</span>),
                <span class="kw">full_width</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">position</span> <span class="kw">=</span> <span class="st">"center"</span>)</pre></body></html></div>
<table class="table table table-condensed table-hover table-striped table-responsive">
<thead><tr>
<th style="text-align:right;">
Model
</th>
<th style="text-align:right;">
# params.
</th>
<th style="text-align:right;">
Log like.
</th>
<th style="text-align:right;">
AIC
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-409.40
</td>
<td style="text-align:right;">
411.40
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
-409.23
</td>
<td style="text-align:right;">
413.23
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
-407.44
</td>
<td style="text-align:right;">
415.44
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
-396.22
</td>
<td style="text-align:right;">
406.22
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
-395.82
</td>
<td style="text-align:right;">
409.82
</td>
</tr>
</tbody>
</table>
<p>Note that log likelihood increases as the model number increases, which should be the case since the models are nested. The best model according to AIC is model 4 which corresponds to the variables <strong>smear, hiv_neg_pos, hiv_unk_pos, rel_time</strong>.</p>
<p>The estimated paramters for this model are</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">beta_list</span><span class="kw">[[</span><span class="fl">4</span>]] <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/reexports.html">kable</a></span>(<span class="kw">digits</span> <span class="kw">=</span> <span class="fl">2</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span>(<span class="kw">bootstrap_options</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"condensed"</span>, <span class="st">"hover"</span>, <span class="st">"striped"</span>, <span class="st">"responsive"</span>),
                <span class="kw">full_width</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">position</span> <span class="kw">=</span> <span class="st">"center"</span>)</pre></body></html></div>
<table class="table table table-condensed table-hover table-striped table-responsive">
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
Est.
</th>
<th style="text-align:right;">
lower
</th>
<th style="text-align:right;">
upper
</th>
<th style="text-align:right;">
SE
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
-0.72
</td>
<td style="text-align:right;">
-0.89
</td>
<td style="text-align:right;">
-0.55
</td>
<td style="text-align:right;">
0.38
</td>
</tr>
<tr>
<td style="text-align:left;">
smear
</td>
<td style="text-align:right;">
-0.11
</td>
<td style="text-align:right;">
-0.37
</td>
<td style="text-align:right;">
0.13
</td>
<td style="text-align:right;">
0.31
</td>
</tr>
<tr>
<td style="text-align:left;">
hiv_neg_pos
</td>
<td style="text-align:right;">
-0.36
</td>
<td style="text-align:right;">
-0.59
</td>
<td style="text-align:right;">
-0.14
</td>
<td style="text-align:right;">
0.36
</td>
</tr>
<tr>
<td style="text-align:left;">
hiv_unk_pos
</td>
<td style="text-align:right;">
-0.56
</td>
<td style="text-align:right;">
-1.41
</td>
<td style="text-align:right;">
0.06
</td>
<td style="text-align:right;">
0.49
</td>
</tr>
<tr>
<td style="text-align:left;">
rel_time
</td>
<td style="text-align:right;">
0.35
</td>
<td style="text-align:right;">
0.27
</td>
<td style="text-align:right;">
0.42
</td>
<td style="text-align:right;">
0.07
</td>
</tr>
</tbody>
</table>
<p>where <code>lower</code> is the lower boundary for 95% likelihood profiling CI and <code>upper</code> is the upper boundary. The variable <code>SE</code> is the estimated standard error using the Hessian from the optimization process as an estimate for the Fisher Information. Using these boundaries, we see that <strong>HIV- compared to HIV+</strong> and <strong>relative time</strong> are both significant at the <span class="math inline">\(\alpha = .05\)</span> level because 0 is not included in the likelihood profiling CI.</p>
</div>
<div id="multiple-outside-transmissions-model" class="section level3">
<h3 class="hasAnchor">
<a href="#multiple-outside-transmissions-model" class="anchor"></a>Multiple outside transmissions model</h3>
<p>Fitting the <a href="multiple-outside-transmissions-model.html">multiple outside transmissions (MOT) model</a> is as easy as fitting with the base model, we only need to change one argument in two different functions. We fit the above 5 models. Here we use <span class="math inline">\(K=1000\)</span> MC samples but for our full results, we us <span class="math inline">\(10000\)</span>.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">K</span> <span class="kw">&lt;-</span> <span class="fl">1000</span>
<span class="no">my_seed</span> <span class="kw">&lt;-</span> <span class="fl">24</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="no">my_seed</span>)

<span class="co">## MODELS</span>
<span class="co">## models</span>
<span class="no">covariate_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="kw">mode</span> <span class="kw">=</span> <span class="st">"list"</span>, <span class="kw">length</span> <span class="kw">=</span> <span class="fl">5</span>)
<span class="no">covariate_list</span><span class="kw">[[</span><span class="fl">1</span>]] <span class="kw">&lt;-</span> <span class="fl">NA</span>
<span class="no">covariate_list</span><span class="kw">[[</span><span class="fl">2</span>]] <span class="kw">&lt;-</span> <span class="st">"smear"</span>
<span class="no">covariate_list</span><span class="kw">[[</span><span class="fl">3</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"smear"</span>,
                         <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>)
<span class="no">covariate_list</span><span class="kw">[[</span><span class="fl">4</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"smear"</span>,
                         <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>,
                         <span class="st">"rel_time"</span>)
<span class="no">covariate_list</span><span class="kw">[[</span><span class="fl">5</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"smear"</span>,
                         <span class="st">"hiv_neg_pos"</span>, <span class="st">"hiv_unk_pos"</span>,
                         <span class="st">"rel_time"</span>,
                         <span class="st">"race_asian_white"</span>,
                         <span class="st">"race_black_white"</span>)

<span class="co">## Set up outputs</span>
<span class="no">loglike_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">model</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_list</span>),
                         <span class="kw">n_params</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">7</span>),
                         <span class="kw">loglike</span> <span class="kw">=</span> <span class="fl">0</span>,
                         <span class="kw">aic</span> <span class="kw">=</span> <span class="fl">0</span>)
<span class="no">beta_mat1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">4</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">beta_mat1</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Intercept"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">beta_mat1</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Est."</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>, <span class="st">"SE"</span>)
<span class="no">beta_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="kw">mode</span> <span class="kw">=</span> <span class="st">"list"</span>, <span class="kw">length</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_list</span>))
<span class="no">beta_list</span><span class="kw">[[</span><span class="fl">1</span>]] <span class="kw">&lt;-</span> <span class="no">beta_mat1</span>
<span class="kw">for</span>(<span class="no">ii</span> <span class="kw">in</span> <span class="fl">2</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_list</span>)){
  <span class="no">mat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_list</span><span class="kw">[[</span><span class="no">ii</span>]]) + <span class="fl">1</span>,
                <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">4</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">mat</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Intercept"</span>, <span class="no">covariate_list</span><span class="kw">[[</span><span class="no">ii</span>]])
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">mat</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Est."</span>, <span class="st">"lower"</span>, <span class="st">"upper"</span>, <span class="st">"SE"</span>)
  <span class="no">beta_list</span><span class="kw">[[</span><span class="no">ii</span>]] <span class="kw">&lt;-</span> <span class="no">mat</span>
}</pre></body></html></div>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">t_init</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()[<span class="fl">3</span>]

<span class="co">## Sample MC trees all at once</span>

    <span class="no">t0</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()[<span class="fl">3</span>]
    <span class="co">## Sample all MC clusters at once for each of the 5 models</span>
    <span class="no">mc_trees</span> <span class="kw">&lt;-</span>  <span class="fu"><a href="../../reference/sample_mc_trees.html">sample_mc_trees</a></span>(<span class="no">clusters</span>,
                                 <span class="kw">B</span> <span class="kw">=</span> <span class="no">K</span>,
                                 <span class="kw">multiple_outside_transmissions</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                                 <span class="kw">covariate_names</span> <span class="kw">=</span> <span class="no">covariate_list</span><span class="kw">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_list</span>)]])
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()[<span class="fl">3</span>] - <span class="no">t0</span>)


<span class="co">## Fit each of the models</span>

<span class="kw">for</span>(<span class="no">jj</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_list</span>)){
        <span class="no">covariate_names</span> <span class="kw">&lt;-</span> <span class="no">covariate_list</span><span class="kw">[[</span><span class="no">jj</span>]]
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Model:"</span>)
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">covariate_names</span>)
        <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">covariate_names</span>[<span class="fl">1</span>])){
            <span class="no">init_params</span> <span class="kw">&lt;-</span> <span class="fl">0</span>
        } <span class="kw">else</span>{
            <span class="no">init_params</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_names</span>) + <span class="fl">1</span>)
        }
        <span class="co">## Optimize</span>

        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Optimizing"</span>)
        <span class="no">bds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(-<span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">init_params</span>))
        <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">covariate_names</span>) <span class="kw">&gt;</span> <span class="fl">5</span>){
            <span class="no">bds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(-<span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">init_params</span>))
        }
        <span class="no">lower_bds</span> <span class="kw">&lt;-</span> <span class="no">bds</span>
        <span class="no">upper_bds</span> <span class="kw">&lt;-</span> -<span class="no">bds</span>
        <span class="no">cov_mat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/covariate_df_to_mat.html">covariate_df_to_mat</a></span>(<span class="no">mc_trees</span>,
                                       <span class="kw">cov_names</span> <span class="kw">=</span> <span class="no">covariate_names</span>)

    <span class="no">t1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()[<span class="fl">3</span>]
    <span class="no">best_params</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span>(<span class="kw">par</span> <span class="kw">=</span> <span class="no">init_params</span>,
                         <span class="kw">fn</span> <span class="kw">=</span> <span class="no">general_loglike</span>,
                         <span class="kw">mc_trees</span> <span class="kw">=</span> <span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span>(<span class="no">mc_trees</span>),
                         <span class="kw">return_neg</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                         <span class="kw">cov_mat</span> <span class="kw">=</span> <span class="no">cov_mat</span>,
                         <span class="kw">cov_names</span> <span class="kw">=</span> <span class="no">covariate_names</span>,
                         <span class="kw">use_outsider_prob</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                         <span class="kw">multiple_outside_transmissions</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                         <span class="kw">method</span> <span class="kw">=</span> <span class="st">"L-BFGS-B"</span>,
                         <span class="kw">lower</span> <span class="kw">=</span> <span class="no">lower_bds</span>,
                         <span class="kw">upper</span> <span class="kw">=</span> <span class="no">upper_bds</span>,
                         <span class="kw">hessian</span> <span class="kw">=</span> <span class="fl">TRUE</span>
                         )
    <span class="no">t2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()[<span class="fl">3</span>] - <span class="no">t1</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Optimization time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>( <span class="no">t2</span> / <span class="fl">60</span>, <span class="fl">3</span>),
                <span class="st">"min"</span>))

    <span class="no">beta_list</span><span class="kw">[[</span><span class="no">jj</span>]][, <span class="fl">4</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span>(<span class="no">best_params</span>$<span class="no">hessian</span>))) <span class="co">## SE from Fisher info</span>

    <span class="co">## Likelihood Profile ests</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Likelihood profiling"</span>)
    <span class="no">lp_ests</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/likelihood_profs.html">likelihood_profs</a></span>(<span class="kw">best_pars</span> <span class="kw">=</span> <span class="no">best_params</span>$<span class="no">par</span>,
                                    <span class="kw">max_loglike</span> <span class="kw">=</span> -<span class="no">best_params</span>$<span class="no">value</span>,
                                    <span class="kw">mc_trees</span> <span class="kw">=</span> <span class="no">mc_trees</span>,
                                    <span class="kw">covariate_names</span> <span class="kw">=</span> <span class="no">covariate_names</span>,
                                    <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">.05</span>,
                                    <span class="kw">multiple_outside_transmissions</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

    <span class="no">beta_list</span><span class="kw">[[</span><span class="no">jj</span>]][,-<span class="fl">4</span>] <span class="kw">&lt;-</span> <span class="no">lp_ests</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"best params:"</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">beta_list</span><span class="kw">[[</span><span class="no">jj</span>]])
    <span class="no">loglike_df</span>$<span class="no">loglike</span>[<span class="no">jj</span>] <span class="kw">&lt;-</span> -<span class="no">best_params</span>$<span class="no">val</span>

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Total time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>( (<span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()[<span class="fl">3</span>] - <span class="no">t_init</span>)  / <span class="fl">3600</span>, <span class="fl">3</span>),
                <span class="st">"hrs"</span>))


}</pre></body></html></div>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">loglike_df</span> <span class="kw">&lt;-</span> <span class="no">loglike_df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">aic</span> <span class="kw">=</span> -<span class="no">loglike</span> + <span class="fl">2</span> * <span class="no">n_params</span>,
         <span class="kw">model</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">5</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">model</span>, <span class="fu"><a href="https://tidyr.tidyverse.org/reference/reexports.html">everything</a></span>())


<span class="no">loglike_df</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/reexports.html">kable</a></span>(<span class="kw">digits</span> <span class="kw">=</span> <span class="fl">2</span>,
                     <span class="kw">col.names</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Model"</span>, <span class="st">"# params."</span>, <span class="st">"Log like."</span>, <span class="st">"AIC"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span>(<span class="kw">bootstrap_options</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"condensed"</span>, <span class="st">"hover"</span>, <span class="st">"striped"</span>, <span class="st">"responsive"</span>),
                <span class="kw">full_width</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">position</span> <span class="kw">=</span> <span class="st">"center"</span>)</pre></body></html></div>
<table class="table table table-condensed table-hover table-striped table-responsive">
<thead><tr>
<th style="text-align:right;">
Model
</th>
<th style="text-align:right;">
# params.
</th>
<th style="text-align:right;">
Log like.
</th>
<th style="text-align:right;">
AIC
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-473.20
</td>
<td style="text-align:right;">
475.20
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
-473.03
</td>
<td style="text-align:right;">
477.03
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
-467.47
</td>
<td style="text-align:right;">
475.47
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
-449.24
</td>
<td style="text-align:right;">
459.24
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
-449.20
</td>
<td style="text-align:right;">
463.20
</td>
</tr>
</tbody>
</table>
<p>Note that log likelihood increases as the model number increases, which should be the case since the models are nested. The best model according to AIC is model 4 which corresponds to the variables <strong>smear, hiv_neg_pos, hiv_unk_pos, rel_time</strong>.</p>
<p>The estimated paramters for this model are</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">beta_list</span><span class="kw">[[</span><span class="fl">4</span>]] <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/reexports.html">kable</a></span>(<span class="kw">digits</span> <span class="kw">=</span> <span class="fl">2</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span>(<span class="kw">bootstrap_options</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"condensed"</span>, <span class="st">"hover"</span>, <span class="st">"striped"</span>, <span class="st">"responsive"</span>),
                <span class="kw">full_width</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">position</span> <span class="kw">=</span> <span class="st">"center"</span>)</pre></body></html></div>
<table class="table table table-condensed table-hover table-striped table-responsive">
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
Est.
</th>
<th style="text-align:right;">
lower
</th>
<th style="text-align:right;">
upper
</th>
<th style="text-align:right;">
SE
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Intercept
</td>
<td style="text-align:right;">
-1.72
</td>
<td style="text-align:right;">
-1.91
</td>
<td style="text-align:right;">
-1.54
</td>
<td style="text-align:right;">
0.48
</td>
</tr>
<tr>
<td style="text-align:left;">
smear
</td>
<td style="text-align:right;">
0.54
</td>
<td style="text-align:right;">
0.30
</td>
<td style="text-align:right;">
0.77
</td>
<td style="text-align:right;">
0.41
</td>
</tr>
<tr>
<td style="text-align:left;">
hiv_neg_pos
</td>
<td style="text-align:right;">
-0.60
</td>
<td style="text-align:right;">
-0.85
</td>
<td style="text-align:right;">
-0.37
</td>
<td style="text-align:right;">
0.33
</td>
</tr>
<tr>
<td style="text-align:left;">
hiv_unk_pos
</td>
<td style="text-align:right;">
-1.34
</td>
<td style="text-align:right;">
-3.72
</td>
<td style="text-align:right;">
-0.32
</td>
<td style="text-align:right;">
0.77
</td>
</tr>
<tr>
<td style="text-align:left;">
rel_time
</td>
<td style="text-align:right;">
0.52
</td>
<td style="text-align:right;">
0.46
</td>
<td style="text-align:right;">
0.59
</td>
<td style="text-align:right;">
0.08
</td>
</tr>
</tbody>
</table>
<p>where <code>lower</code> is the lower boundary for 95% likelihood profiling CI and <code>upper</code> is the upper boundary. The variable <code>SE</code> is the estimated standard error using the Hessian from the optimization process as an estimate for the Fisher Information. Using these boundaries, we see that <strong>HIV- compared to HIV+</strong>, <strong>HIV unknown compared to HIV+</strong>, and <strong>relative time</strong> are all significant at the <span class="math inline">\(\alpha = .05\)</span> level because 0 is not included in the likelihood profiling CI. Here we see <strong>smear</strong> is significant, but this is lost when we use <span class="math inline">\(K= 10000\)</span> MC samples instead of <span class="math inline">\(K=1000\)</span> MC samples.</p>
</div>
</div>
<div id="analysis-of-standard-error-and-ci" class="section level2">
<h2 class="hasAnchor">
<a href="#analysis-of-standard-error-and-ci" class="anchor"></a>Analysis of standard error and CI</h2>
<p>We see that the standard errors are large compared to the likelihood profiling CI widths. If we multiplied the standard errors by <span class="math inline">\(2 \times 1.96\)</span>, the width of a 95% CI for a normal distributed variable, then this width is much larger than the likelihood profiling estimate.</p>
<p>To see which estimate is closer to the truth, we can bootstrap our data to get a second standard error and third CI estimate. We provide the function <code><a href="../../reference/bootstrap_clusters.html">bootstrap_clusters()</a></code> to resample clusters from our data. The analysis can be repeated on these bootstrap data sets. Below, we see that our new sampled data set contains the same amount of clusters as the original data but now has a different number of individuals compared to the original 389.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">bootstrap_data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/bootstrap_clusters.html">bootstrap_clusters</a></span>(<span class="no">clusters</span>)

<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="no">bootstrap_data</span>)</pre></body></html></div>
<pre><code>## [1] 371   9</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Shannon Gallagher, Dean Follmann.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
